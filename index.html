<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">
<title>Past My Bedtime</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;touch-action:none;-webkit-user-select:none;user-select:none;}
body{background:#04040d;display:flex;justify-content:center;align-items:center;min-height:100dvh;font-family:'Press Start 2P',cursive;overflow:hidden;position:fixed;width:100%;height:100%;}
#gc{position:relative;display:flex;justify-content:center;align-items:center;width:100%;height:100%;}

/* Canvas scales to fit screen keeping aspect ratio */
canvas{display:block;image-rendering:pixelated;image-rendering:crisp-edges;
  width:min(100vw, calc(100dvh * 480/900));
  height:min(100dvh, calc(100vw * 900/480));
  max-width:600px;max-height:1125px;}

/* Screens */
.screen{position:absolute;top:0;left:0;width:100%;height:100%;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;z-index:20;padding:clamp(12px,4vw,24px);overflow-y:auto;}
.sbg{position:absolute;inset:0;background:radial-gradient(ellipse at 50% 30%,#0d0d2e 0%,#04040d 100%);z-index:-1;}
.star{position:absolute;border-radius:50%;background:#fff;animation:twinkle var(--d,3s) ease-in-out infinite var(--dl,0s);}
@keyframes twinkle{0%,100%{opacity:0.07;}50%{opacity:var(--op,.5);}}
.moon{font-size:clamp(28px,8vw,44px);margin-bottom:10px;animation:float 3s ease-in-out infinite;filter:drop-shadow(0 0 16px #a29bfe55);}
@keyframes float{0%,100%{transform:translateY(0);}50%{transform:translateY(-8px);}}
h1{font-size:clamp(11px,3.5vw,24px);margin-bottom:8px;letter-spacing:.03em;}
.tm{color:#ff6b9d;text-shadow:0 0 28px #ff6b9d55,3px 3px 0 #7d1c3a;}
.tb{color:#e74c3c;text-shadow:0 0 28px #e74c3c55,3px 3px 0 #7d1200;}
.tw{color:#00b894;text-shadow:0 0 28px #00b89455,3px 3px 0 #006b47;}
.sub{font-size:clamp(6px,2vw,9px);color:#6878aa;margin-bottom:14px;line-height:2;max-width:min(300px,85vw);}
.sub em{color:#a29bfe;font-style:normal;}
button{background:transparent;border:2px solid #5a4ecc;color:#9090ee;padding:clamp(8px,2.5vw,12px) clamp(14px,4vw,24px);font-family:'Press Start 2P',cursive;font-size:clamp(7px,2.2vw,10px);cursor:pointer;border-radius:3px;letter-spacing:.06em;transition:background .15s,color .15s,border-color .15s;position:relative;overflow:hidden;margin:4px;touch-action:manipulation;-webkit-tap-highlight-color:transparent;min-height:44px;}
button:active{background:#5a4ecc;color:#fff;}
.hidden{display:none!important;}

/* HUD ‚Äî scales with canvas */
#hud{position:absolute;top:0;left:50%;transform:translateX(-50%);
  width:min(100vw, calc(100dvh * 480/900));
  max-width:600px;
  pointer-events:none;z-index:10;}
.htop{display:flex;justify-content:space-between;padding:6px 8px;gap:4px;}
.hl{display:flex;flex-direction:column;gap:3px;}
.hr{display:flex;flex-direction:column;align-items:flex-end;gap:3px;}
.pill{background:rgba(4,4,22,.88);border:1px solid rgba(120,120,220,.28);border-radius:3px;padding:3px 6px;font-size:clamp(5px,1.4vw,7px);color:#6070aa;white-space:nowrap;}
#stv{color:#74b9ff;}#lvlb{color:#ff6b9d;}#strv{color:#fdcb6e;}
.slw{display:flex;flex-direction:column;align-items:flex-end;gap:2px;}
.sll{font-size:clamp(5px,1.3vw,6px);color:#6070aa;}
.slb{width:clamp(70px,18vw,110px);height:6px;background:rgba(4,4,22,.9);border:1px solid rgba(120,120,220,.28);border-radius:2px;overflow:hidden;}
.slf{height:100%;width:0%;background:linear-gradient(90deg,#00b894 0%,#fdcb6e 55%,#e17055 80%,#d63031 100%);transition:width .15s;}
#objs{display:flex;gap:3px;flex-wrap:wrap;justify-content:center;padding:0 6px 3px;}
.obj{background:rgba(4,4,22,.88);border:1px solid rgba(120,120,220,.2);border-radius:3px;padding:2px 5px;font-size:clamp(5px,1.3vw,6px);color:#404070;transition:all .25s;}
.obj.active{color:#74b9ff;border-color:rgba(116,185,255,.45);}
.obj.done{color:#00b894;border-color:rgba(0,184,148,.45);}
#ni{position:absolute;top:45%;left:50%;transform:translate(-50%,-50%);font-size:clamp(8px,2.5vw,11px);opacity:0;z-index:10;color:#ff6b6b;text-shadow:0 0 12px #f00a;letter-spacing:.1em;pointer-events:none;transition:opacity .1s;}
#cc{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:11;border:5px solid rgba(231,76,60,0);transition:border-color .08s;}
#cc.danger{border-color:rgba(231,76,60,.65);}
.toast{position:absolute;left:50%;transform:translateX(-50%);font-size:clamp(7px,2.2vw,10px);pointer-events:none;z-index:15;white-space:nowrap;animation:tUp 1.8s ease-out forwards;max-width:90vw;text-align:center;}
@keyframes tUp{0%{opacity:1;transform:translateX(-50%) translateY(0);}100%{opacity:0;transform:translateX(-50%) translateY(-50px);}}

/* Level intro card */
#lcard{position:absolute;top:0;left:0;width:100%;height:100%;display:flex;flex-direction:column;justify-content:center;align-items:center;z-index:25;background:rgba(4,4,13,.97);opacity:0;pointer-events:none;transition:opacity .35s;padding:clamp(12px,4vw,24px);text-align:center;overflow-y:auto;}
#lcard.show{opacity:1;pointer-events:auto;}
#lcard h2{font-size:clamp(11px,3.2vw,20px);color:#ff6b9d;text-shadow:0 0 18px #ff6b9d55,3px 3px 0 #7d1c3a;margin-bottom:8px;}
.lcsub{font-size:clamp(6px,1.8vw,8px);color:#6878aa;line-height:2;margin-bottom:5px;max-width:min(270px,85vw);}
.lctip{font-size:clamp(5px,1.6vw,7px);color:#a29bfe;margin-bottom:14px;}
.lcobjs{display:flex;flex-wrap:wrap;gap:4px;justify-content:center;margin-bottom:12px;}
.lcobj{font-size:clamp(5px,1.5vw,7px);background:rgba(90,78,204,.15);border:1px solid rgba(162,155,254,.3);border-radius:3px;padding:3px 7px;color:#a29bfe;}

/* Touch controls ‚Äî positioned relative to canvas */
#tc{position:absolute;bottom:0;left:50%;transform:translateX(-50%);
  width:min(100vw, calc(100dvh * 480/900));
  max-width:600px;
  height:clamp(110px,28vw,145px);pointer-events:none;display:none;}
.tz{position:absolute;pointer-events:auto;border-radius:50%;background:rgba(90,78,204,.15);border:2px solid rgba(162,155,254,.3);display:flex;align-items:center;justify-content:center;color:rgba(162,155,254,.6);font-size:clamp(6px,2vw,9px);touch-action:manipulation;-webkit-tap-highlight-color:transparent;}
.tz:active,.tz.active{background:rgba(90,78,204,.32);}
#joy{left:clamp(12px,3.5vw,24px);bottom:clamp(12px,3.5vw,22px);width:clamp(75px,20vw,100px);height:clamp(75px,20vw,100px);}
#jk{width:38%;height:38%;background:rgba(162,155,254,.22);border-radius:50%;position:absolute;}
#rb{right:clamp(90px,24vw,115px);bottom:clamp(18px,5vw,32px);width:clamp(46px,13vw,62px);height:clamp(46px,13vw,62px);}
#ab{right:clamp(12px,3.5vw,22px);bottom:clamp(18px,5vw,32px);width:clamp(46px,13vw,62px);height:clamp(46px,13vw,62px);}
@media(max-width:768px),(pointer:coarse){#tc{display:block;}}

/* Pause menu */
#pauseMenu{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(2,2,18,.93);z-index:40;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:0;overflow-y:auto;padding:16px;}
#pauseInner{display:flex;flex-direction:column;align-items:center;gap:8px;}
.pmoon{font-size:clamp(26px,7vw,36px);margin-bottom:6px;animation:float 3s ease-in-out infinite;}
#settingsPanel{display:flex;flex-direction:column;align-items:center;gap:10px;width:100%;max-width:min(310px,90vw);}
.stoggle{background:rgba(90,78,204,.18);border:1.5px solid rgba(162,155,254,.3);color:#a29bfe;font-family:'Press Start 2P',cursive;font-size:clamp(6px,1.8vw,8px);padding:8px 14px;cursor:pointer;border-radius:3px;min-width:64px;touch-action:manipulation;min-height:40px;}
.stoggle.on{border-color:#00b894;color:#00b894;}
input[type=range]{-webkit-appearance:none;width:clamp(80px,22vw,120px);height:5px;border-radius:2px;background:rgba(162,155,254,.25);outline:none;cursor:pointer;touch-action:manipulation;}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:18px;height:18px;border-radius:50%;background:#a29bfe;cursor:pointer;}
.ctrl-opts{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;}
.ctrl-opt{background:rgba(90,78,204,.12);border:2px solid rgba(162,155,254,.2);border-radius:4px;padding:10px 14px;cursor:pointer;font-size:clamp(6px,1.8vw,8px);color:#7080a0;display:flex;flex-direction:column;align-items:center;gap:5px;touch-action:manipulation;min-height:44px;}
.ctrl-opt.sel{border-color:#a29bfe;color:#a29bfe;background:rgba(90,78,204,.25);}

/* PC keyboard overlay */
#pcCtrl{position:absolute;bottom:10px;left:50%;transform:translateX(-50%);display:none;flex-direction:column;align-items:center;gap:4px;z-index:10;pointer-events:auto;}
.kb{width:36px;height:36px;background:rgba(10,10,30,.88);border:1.5px solid rgba(162,155,254,.35);border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:8px;color:rgba(162,155,254,.7);cursor:pointer;user-select:none;font-family:'Press Start 2P',cursive;border-bottom:3px solid rgba(90,78,204,.5);touch-action:manipulation;}
.kb.pressed,.kb:active{background:rgba(90,78,204,.4);border-color:#a29bfe;color:#fff;transform:translateY(1px);}
.kb.wide{width:62px;}
.kb.action{border-color:rgba(0,184,148,.4);color:rgba(0,184,148,.7);}
.kb.action.pressed{border-color:#00b894;color:#00b894;}
.kb.run-key{border-color:rgba(231,76,60,.35);color:rgba(231,76,60,.6);}
.kb.run-key.pressed{border-color:#e74c3c;color:#e74c3c;}
#pcCtrlLabel{font-size:6px;color:rgba(162,155,254,.35);text-align:center;margin-top:2px;}

/* ‚îÄ‚îÄ AVATAR EDITOR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
#avEditor{
  position:absolute;top:0;left:0;width:100%;height:100%;
  background:linear-gradient(180deg,#04040d 0%,#0a0818 100%);
  z-index:30;display:flex;flex-direction:column;align-items:center;
  overflow:hidden;
}
/* Fixed top bar */
.av-topbar{
  width:100%;flex-shrink:0;
  display:flex;align-items:center;justify-content:space-between;
  padding:clamp(10px,3vw,16px) clamp(14px,4vw,22px);
  border-bottom:1px solid rgba(162,155,254,.1);
  background:rgba(4,4,18,.8);
}
.av-topbar-title{font-size:clamp(9px,2.8vw,12px);color:#ff6b9d;letter-spacing:.06em;}
.av-topbar-coins{font-size:clamp(7px,2vw,9px);color:#fdcb6e;background:rgba(253,203,110,.1);border:1px solid rgba(253,203,110,.25);border-radius:4px;padding:4px 10px;}

/* Preview panel ‚Äî horizontal layout: canvas left, info right */
.av-preview-row{
  width:100%;max-width:360px;flex-shrink:0;
  display:flex;align-items:center;gap:14px;
  padding:clamp(12px,3vw,18px) clamp(14px,4vw,22px) 0;
}
#avPreview{flex-shrink:0;position:relative;}
#avPreview canvas{
  width:clamp(80px,22vw,110px);height:clamp(80px,22vw,110px);
  display:block;border:2px solid rgba(162,155,254,.3);
  border-radius:10px;background:radial-gradient(ellipse at 50% 40%,#12123a 0%,#06060f 100%);
  image-rendering:pixelated;
}
.av-preview-info{flex:1;display:flex;flex-direction:column;gap:8px;}
.av-name-label{font-size:clamp(5px,1.4vw,6px);color:#6070aa;letter-spacing:.08em;margin-bottom:2px;}
.av-name-input{
  background:rgba(4,4,22,.9);border:1.5px solid rgba(120,120,220,.35);
  border-radius:4px;color:#a29bfe;font-family:'Press Start 2P',cursive;
  font-size:clamp(6px,1.8vw,8px);padding:8px 10px;width:100%;outline:none;
  touch-action:manipulation;-webkit-tap-highlight-color:transparent;
}
.av-name-input:focus{border-color:#a29bfe;}
.av-hint{font-size:clamp(4px,1.2vw,5px);color:#384060;line-height:1.8;}

/* Scrollable cards area */
.av-scroll{
  flex:1;overflow-y:auto;overflow-x:hidden;
  width:100%;padding:clamp(10px,3vw,16px) clamp(14px,4vw,22px) clamp(16px,4vw,24px);
  display:flex;flex-direction:column;align-items:center;gap:10px;
  -webkit-overflow-scrolling:touch;
}
.av-card{
  background:rgba(8,8,28,.85);
  border:1px solid rgba(162,155,254,.12);
  border-radius:10px;padding:12px 14px;
  width:100%;max-width:360px;
}
.av-card-header{
  display:flex;align-items:center;justify-content:space-between;
  margin-bottom:10px;
}
.av-card-title{font-size:clamp(5px,1.5vw,7px);color:#8090b0;letter-spacing:.1em;text-transform:uppercase;}
.av-card-sub{font-size:clamp(4px,1.2vw,5px);color:#404868;}

/* Skin swatches ‚Äî circle style */
.av-skin-grid{display:flex;flex-wrap:wrap;gap:10px;}
.av-skin-sw{
  width:clamp(32px,9vw,42px);height:clamp(32px,9vw,42px);
  border-radius:50%;border:3px solid transparent;
  cursor:pointer;transition:all .12s;
  touch-action:manipulation;-webkit-tap-highlight-color:transparent;
  position:relative;flex-shrink:0;
}
.av-skin-sw.sel{border-color:#fff;box-shadow:0 0 10px rgba(255,255,255,.5);}
.av-skin-sw.sel::after{
  content:'‚úì';position:absolute;inset:0;display:flex;align-items:center;
  justify-content:center;font-size:12px;color:#fff;font-family:sans-serif;
  text-shadow:0 1px 3px rgba(0,0,0,.8);
}

/* Hair style tiles ‚Äî numbered, with color bar */
.av-hair-grid{display:flex;flex-wrap:wrap;gap:7px;}
.av-hair-tile{
  width:clamp(54px,15vw,70px);height:clamp(42px,11vw,52px);
  border-radius:7px;border:2px solid rgba(162,155,254,.15);
  cursor:pointer;transition:all .12s;
  touch-action:manipulation;-webkit-tap-highlight-color:transparent;
  position:relative;overflow:hidden;flex-shrink:0;
  display:flex;flex-direction:column;align-items:stretch;
}
.av-hair-tile.sel{border-color:#a29bfe;box-shadow:0 0 8px rgba(162,155,254,.4);}
.av-hair-tile.sel::after{
  content:'‚úì';position:absolute;top:2px;right:4px;
  font-size:9px;color:#fff;font-family:sans-serif;
  text-shadow:0 1px 3px rgba(0,0,0,.9);
}
.av-hair-color-bar{height:60%;width:100%;}
.av-hair-name{
  flex:1;display:flex;align-items:center;justify-content:center;
  font-size:clamp(4px,1.1vw,5px);color:rgba(255,255,255,.7);
  font-family:'Press Start 2P',cursive;
  background:rgba(0,0,0,.5);line-height:1;padding:2px;text-align:center;
}

/* Outfit swatches */
.av-outfit-grid{display:flex;flex-wrap:wrap;gap:8px;}
.av-outfit-sw{
  width:clamp(36px,10vw,48px);height:clamp(36px,10vw,48px);
  border-radius:8px;border:2px solid transparent;
  cursor:pointer;transition:all .12s;
  touch-action:manipulation;-webkit-tap-highlight-color:transparent;
  position:relative;flex-shrink:0;
}
.av-outfit-sw.sel{border-color:#fff;box-shadow:0 0 8px rgba(255,255,255,.4);}
.av-outfit-sw.sel::after{
  content:'‚úì';position:absolute;inset:0;display:flex;align-items:center;
  justify-content:center;font-size:12px;color:#fff;font-family:sans-serif;
  text-shadow:0 1px 3px rgba(0,0,0,.8);
}
.av-outfit-sw.av-locked{opacity:0.55;}
.av-free-badge{
  position:absolute;top:1px;left:1px;
  font-size:4px;color:#00b894;font-family:'Press Start 2P',cursive;
  background:rgba(0,184,148,.2);border-radius:2px;padding:1px 3px;
  pointer-events:none;border:1px solid rgba(0,184,148,.4);
}
.av-lock-label{
  position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
  font-size:clamp(5px,1.4vw,7px);color:#fdcb6e;font-family:'Press Start 2P',cursive;
  background:rgba(0,0,0,.5);border-radius:6px;pointer-events:none;
  flex-direction:column;gap:1px;
}
.av-lock-label span{font-size:4px;color:#a08030;}

/* Action buttons */
.av-btns{display:flex;gap:10px;justify-content:center;width:100%;max-width:360px;padding:4px 0 8px;}
.av-btns button{flex:1;max-width:160px;}

/* Update log */
.ul-entry{background:rgba(10,10,30,.8);border:1px solid rgba(162,155,254,.15);border-radius:8px;padding:12px 14px;margin-bottom:2px;}
.ul-ver{font-size:clamp(8px,2.5vw,11px);color:#a29bfe;margin-bottom:4px;}
.ul-date{font-size:5px;color:#404868;margin-bottom:8px;}
.ul-note{font-size:clamp(5px,1.4vw,6px);color:#6878aa;line-height:2.4;padding-left:8px;}
.ul-note::before{content:'‚ñ∏ ';}
/* Coin badge */
.coins-badge{display:inline-block;background:rgba(253,203,110,.1);border:1px solid rgba(253,203,110,.28);border-radius:4px;padding:4px 10px;font-size:clamp(7px,2vw,9px);color:#fdcb6e;margin-bottom:12px;}
</style>
</head>
<body>

<div id="gc">
<canvas id="c"></canvas>

<div id="hud">
  <div class="htop">
    <div class="hl">
      <div class="pill" id="lvlb">LEVEL 1</div>
      <div class="pill">STATUS: <span id="stv">SNEAKING</span></div>
      <div class="pill">STREAK <span id="strv">0</span></div>
    </div>
    <div class="hr">
      <div class="pill coin-display" style="color:#fdcb6e;">ü™ô 0</div>
      <div class="slw"><div class="sll">SLEEPINESS</div><div class="slb"><div class="slf" id="sf"></div></div></div>
    </div>
  </div>
  <div id="objs"></div>
</div>
<!-- Version badge -->
<div id="verBadge" style="position:absolute;bottom:6px;right:8px;font-size:5px;color:rgba(162,155,254,.35);font-family:'Press Start 2P',cursive;pointer-events:auto;cursor:pointer;z-index:12;" onclick="showUpdateLog()">v1.5.0</div>

<div id="ni">!! NOISY !!</div>
<div id="cc"></div>

<div id="tc">
  <div class="tz" id="joy"><div id="jk"></div></div>
  <div class="tz" id="rb">RUN</div>
  <div class="tz" id="ab">USE</div>
</div>

<!-- Level card -->
<div id="lcard">
  <div class="moon" id="lcmoon">üåô</div>
  <h2 id="lctitle">LEVEL 1</h2>
  <div class="lcsub" id="lcsub"></div>
  <div class="lctip" id="lctip"></div>
  <div class="lcobjs" id="lcobjs"></div>
  <button onclick="dismissCard()">‚ñ∂ LET'S GO!</button>
</div>

<!-- Start screen -->
<div id="ss" class="screen">
  <div class="sbg" id="sbg"></div>
  <div class="moon">üåô</div>
  <h1 class="tm">PAST MY BEDTIME</h1>
  <div class="sub">6 levels of sneaking.<br><em>Keys ¬∑ doors ¬∑ guards ¬∑ and the great outdoors.</em></div>
  <div class="coins-badge coin-display" style="margin-bottom:10px;">ü™ô 0 coins</div>
  <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:center;">
    <button onclick="showDiffSelect()">‚ñ∂ PLAY</button>
    <button onclick="showAvatarEditor()">üë§ AVATAR</button>
    <button onclick="showUpdateLog()" style="font-size:clamp(6px,1.8vw,8px);">üìã UPDATES</button>
  </div>
</div>

<!-- Difficulty select -->
<div id="diffSelect" class="screen hidden">
  <div class="sbg"></div>
  <div class="moon">üåô</div>
  <h1 class="tm" style="margin-bottom:6px;">CHOOSE DIFFICULTY</h1>
  <div class="sub" style="margin-bottom:20px;">How sneaky are you?</div>
  <div style="display:flex;flex-direction:column;gap:10px;width:100%;max-width:280px;">
    <div id="dopt-easy" onclick="pickDiff('easy')" class="dopt" style="background:rgba(0,184,148,.08);border:2px solid rgba(0,184,148,.3);border-radius:6px;padding:14px 18px;cursor:pointer;text-align:left;transition:all .15s;touch-action:manipulation;">
      <div style="font-size:10px;color:#00b894;margin-bottom:5px;">üü¢ EASY</div>
      <div style="font-size:6px;color:#6878aa;line-height:2;">Dad has a shorter detection range.<br>Good for first-timers.</div>
    </div>
    <div id="dopt-medium" onclick="pickDiff('medium')" class="dopt" style="background:rgba(162,155,254,.08);border:2px solid rgba(162,155,254,.35);border-radius:6px;padding:14px 18px;cursor:pointer;text-align:left;transition:all .15s;touch-action:manipulation;">
      <div style="font-size:10px;color:#a29bfe;margin-bottom:5px;">üü£ MEDIUM</div>
      <div style="font-size:6px;color:#6878aa;line-height:2;">Standard detection. The classic experience.</div>
    </div>
    <div id="dopt-hard" onclick="pickDiff('hard')" class="dopt" style="background:rgba(231,76,60,.06);border:2px solid rgba(231,76,60,.25);border-radius:6px;padding:14px 18px;cursor:pointer;text-align:left;transition:all .15s;touch-action:manipulation;">
      <div style="font-size:10px;color:#e74c3c;margin-bottom:5px;">üî¥ HARD</div>
      <div style="font-size:6px;color:#6878aa;line-height:2;">Dad sees much further. No mercy.</div>
    </div>
  </div>
  <button onclick="document.getElementById('diffSelect').classList.add('hidden');document.getElementById('ss').classList.remove('hidden');" style="margin-top:16px;">‚Üê BACK</button>
</div>

<!-- Game over -->
<div id="go" class="screen hidden">
  <div class="sbg"></div>
  <div class="moon" style="filter:drop-shadow(0 0 18px #e74c3c88)">üò¥</div>
  <h1 class="tb">BUSTED!</h1>
  <div class="sub" id="dr">Dad caught you!</div>
  <div class="coins-badge coin-display" style="margin-bottom:10px;">ü™ô 0 coins</div>
  <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:center;">
    <button onclick="retryLevel()">‚Ü∫ RETRY</button>
    <button onclick="showAvatarEditor()">üë§ AVATAR</button>
  </div>
</div>

<!-- Level win -->
<div id="lw" class="screen hidden">
  <div class="sbg"></div>
  <div class="moon" id="lwmoon">‚≠ê</div>
  <h1 class="tw" id="lwtitle">LEVEL 1 CLEAR!</h1>
  <div class="sub" id="lwsub"></div>
  <div id="lwst" style="font-size:7px;color:#6878aa;margin-bottom:16px;line-height:2.2;"></div>
  <button onclick="nextLevel()">‚ñ∂ NEXT LEVEL</button>
</div>

<!-- All done -->
<div id="ws" class="screen hidden">
  <div class="sbg"></div>
  <div class="moon" style="filter:drop-shadow(0 0 18px #00b89488)">üèÜ</div>
  <h1 class="tw">YOU WIN!</h1>
  <div class="sub">All 6 levels cleared!<br><em>Sweet dreams, legend. You made it outside and back.</em></div>
  <div id="wst" style="font-size:7px;color:#6878aa;margin-bottom:16px;line-height:2.2;"></div>
  <div class="sub coin-display" style="color:#fdcb6e;margin-bottom:12px;">ü™ô 0</div>
  <button onclick="location.reload()">‚ñ∂ PLAY AGAIN</button>
</div>

<!-- Update log -->
<div id="updateLog" class="screen hidden" style="justify-content:flex-start;padding-top:clamp(16px,5vw,32px);">
  <div class="sbg"></div>
  <div style="font-size:clamp(10px,3vw,13px);color:#a29bfe;margin-bottom:6px;letter-spacing:.05em;">üìã UPDATE LOG</div>
  <div class="coins-badge coin-display">ü™ô 0 coins</div>
  <div id="ulContent" style="width:100%;max-width:min(340px,90vw);display:flex;flex-direction:column;gap:8px;overflow-y:auto;flex:1;text-align:left;padding:4px 2px;"></div>
  <button onclick="document.getElementById('updateLog').classList.add('hidden')" style="margin-top:12px;flex-shrink:0;">‚Üê BACK</button>
</div>

<!-- Avatar editor -->
<div id="avEditor" class="hidden">

  <!-- Fixed top bar -->
  <div class="av-topbar">
    <div class="av-topbar-title">üë§ CUSTOMIZE YOUR KID</div>
    <div class="av-topbar-coins coin-display">ü™ô 0</div>
  </div>

  <!-- Fixed preview row (not in scroll) -->
  <div class="av-preview-row">
    <div id="avPreview"><canvas id="avc" width="110" height="110"></canvas></div>
    <div class="av-preview-info">
      <div class="av-name-label">YOUR NAME</div>
      <input id="avName" class="av-name-input" maxlength="10" value="KID"
        oninput="renderAvPreview()" autocomplete="off" spellcheck="false">
      <div class="av-hint">Tap swatches below<br>to change your look</div>
    </div>
  </div>

  <!-- Scrollable customisation cards -->
  <div class="av-scroll">

    <!-- Skin Tone -->
    <div class="av-card">
      <div class="av-card-header">
        <div class="av-card-title">Skin Tone</div>
        <div class="av-card-sub">6 options</div>
      </div>
      <div class="av-skin-grid" id="skinSwatches"></div>
    </div>

    <!-- Hair Style -->
    <div class="av-card">
      <div class="av-card-header">
        <div class="av-card-title">Hair Style</div>
        <div class="av-card-sub" id="hairLabel">Hair 1</div>
      </div>
      <div class="av-hair-grid" id="hairSwatches"></div>
    </div>

    <!-- Outfit -->
    <div class="av-card">
      <div class="av-card-header">
        <div class="av-card-title">Outfit</div>
        <div class="av-card-sub">ü™ô Tap locked to buy</div>
      </div>
      <div class="av-outfit-grid" id="outfitSwatches"></div>
    </div>

    <!-- Save / Back -->
    <div class="av-btns">
      <button onclick="saveAvatar()">‚úì SAVE</button>
      <button onclick="closeAvatarEditor()">‚Üê BACK</button>
    </div>

  </div>
</div>

<!-- ‚îÄ‚îÄ PAUSE MENU ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div id="pauseMenu" class="hidden">

  <!-- Main pause buttons -->
  <div id="pauseInner" style="display:flex;flex-direction:column;align-items:center;gap:10px;">
    <div style="font-size:36px;animation:float 3s ease-in-out infinite;margin-bottom:8px;">üåô</div>
    <div style="font-size:16px;color:#a29bfe;text-shadow:0 0 20px #a29bfe55;margin-bottom:14px;letter-spacing:.05em;">PAUSED</div>
    <button onclick="resumeGame()">‚ñ∂ RESUME</button>
    <button onclick="openSettings()">‚öô SETTINGS</button>
    <button onclick="showAvatarEditor()">üë§ AVATAR</button>
    <button onclick="quitToMenu()">‚úï QUIT TO MENU</button>
  </div>

  <!-- Settings panel -->
  <div id="settingsPanel" class="hidden" style="display:flex;flex-direction:column;align-items:center;gap:12px;width:100%;max-width:min(310px,92vw);">
    <div style="font-size:clamp(9px,2.8vw,13px);color:#ff6b9d;margin-bottom:2px;">‚öô SETTINGS</div>
    <div style="width:100%;height:1px;background:rgba(162,155,254,.15);"></div>

    <div style="font-size:clamp(5px,1.6vw,7px);color:#8090b0;align-self:flex-start;">CONTROLS</div>
    <div class="ctrl-opts">
      <div id="ctrlMobile" onclick="setControls('mobile')" class="ctrl-opt sel">
        <span style="font-size:clamp(16px,5vw,22px);">üì±</span>
        <span>MOBILE</span>
      </div>
      <div id="ctrlPC" onclick="setControls('pc')" class="ctrl-opt">
        <span style="font-size:clamp(16px,5vw,22px);">üñ•Ô∏è</span>
        <span>PC / KEYBOARD</span>
      </div>
    </div>

    <div style="width:100%;height:1px;background:rgba(162,155,254,.15);"></div>

    <div style="display:flex;justify-content:space-between;align-items:center;width:100%;gap:8px;">
      <span style="font-size:clamp(5px,1.6vw,7px);color:#8090b0;flex:1;">SOUND</span>
      <button id="sfxBtn" class="stoggle on" onclick="setSfx(!settings.sfx)">üîä ON</button>
    </div>
    <div style="display:flex;justify-content:space-between;align-items:center;width:100%;gap:8px;">
      <span style="font-size:clamp(5px,1.6vw,7px);color:#8090b0;flex:1;">VISION CONES</span>
      <button id="visBtn" class="stoggle on" onclick="setVision(!settings.showVision)">üëÅ ON</button>
    </div>

    <div style="width:100%;height:1px;background:rgba(162,155,254,.15);"></div>

    <div style="display:flex;justify-content:space-between;align-items:center;width:100%;gap:6px;">
      <span style="font-size:clamp(5px,1.6vw,7px);color:#8090b0;flex:1;">GUARD SPEED</span>
      <span id="gspdVal" style="font-size:clamp(5px,1.6vw,7px);color:#fdcb6e;min-width:52px;text-align:right;">Normal</span>
      <input type="range" min="0.5" max="2" step="0.5" value="1" oninput="setGuardSpd(this.value)">
    </div>
    <div style="display:flex;justify-content:space-between;align-items:center;width:100%;gap:6px;">
      <span style="font-size:clamp(5px,1.6vw,7px);color:#8090b0;flex:1;">SLEEP RATE</span>
      <span id="slrVal" style="font-size:clamp(5px,1.6vw,7px);color:#fdcb6e;min-width:52px;text-align:right;">Normal</span>
      <input type="range" min="0.5" max="2" step="0.5" value="1" oninput="setSleepRate(this.value)">
    </div>

    <div style="width:100%;height:1px;background:rgba(162,155,254,.15);"></div>
    <button onclick="closeSettings()">‚Üê BACK</button>
  </div>
</div>

<!-- ‚îÄ‚îÄ PC KEYBOARD OVERLAY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div id="pcCtrl" style="position:absolute;bottom:12px;left:50%;transform:translateX(-50%);display:none;flex-direction:column;align-items:center;gap:4px;z-index:10;pointer-events:auto;">
  <!-- Top row: W + action keys -->
  <div style="display:flex;gap:4px;align-items:flex-end;">
    <div style="display:flex;flex-direction:column;gap:4px;">
      <!-- WASD cluster -->
      <div style="display:flex;gap:4px;justify-content:center;">
        <div class="kb" id="kb-w" onmousedown="kd['w']=true" onmouseup="kd['w']=false" onmouseleave="kd['w']=false">W</div>
      </div>
      <div style="display:flex;gap:4px;">
        <div class="kb" id="kb-a" onmousedown="kd['a']=true" onmouseup="kd['a']=false" onmouseleave="kd['a']=false">A</div>
        <div class="kb" id="kb-s" onmousedown="kd['s']=true" onmouseup="kd['s']=false" onmouseleave="kd['s']=false">S</div>
        <div class="kb" id="kb-d" onmousedown="kd['d']=true" onmouseup="kd['d']=false" onmouseleave="kd['d']=false">D</div>
      </div>
    </div>
    <!-- Action keys -->
    <div style="display:flex;flex-direction:column;gap:4px;margin-left:12px;">
      <div class="kb wide run-key" id="kb-shift" onmousedown="kd['shift']=true" onmouseup="kd['shift']=false" onmouseleave="kd['shift']=false">‚áß RUN</div>
      <div class="kb wide action" id="kb-space" onmousedown="kd[' ']=true" onmouseup="kd[' ']=false" onmouseleave="kd[' ']=false">SPACE HIDE</div>
      <div class="kb wide action" id="kb-e" onmousedown="pcPressE()" onmouseup="kd['e']=false" onmouseleave="kd['e']=false">E USE</div>
    </div>
    <!-- Pause -->
    <div style="display:flex;flex-direction:column;justify-content:flex-end;margin-left:10px;">
      <div class="kb wide" onclick="togglePause()" style="font-size:7px;">ESC PAUSE</div>
    </div>
  </div>
  <div id="pcCtrlLabel" style="font-size:6px;color:rgba(162,155,254,.35);letter-spacing:.05em;margin-top:2px;">WASD ¬∑ SHIFT=RUN ¬∑ SPACE=HIDE ¬∑ E=USE</div>
</div>

</div><!-- gc -->
<script>
// ‚îÄ‚îÄ AUDIO ENGINE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const AC=new(window.AudioContext||window.webkitAudioContext)();
function resumeAC(){if(AC.state==='suspended')AC.resume();}
document.addEventListener('keydown',resumeAC,{once:true});
document.addEventListener('touchstart',resumeAC,{once:true});
document.addEventListener('click',resumeAC,{once:true});

// Fix mobile button delay: fire onclick immediately on touchstart
document.addEventListener('touchstart',function(e){
  const btn=e.target.closest('button,[onclick]');
  if(btn){
    e.preventDefault();
    const fn=btn.getAttribute('onclick');
    if(fn)try{new Function(fn)();}catch(err){}
  }
},{passive:false});

function playTone(freq,type,dur,vol,delay){
  try{
    const o=AC.createOscillator(),g=AC.createGain();
    o.connect(g);g.connect(AC.destination);
    o.type=type||'sine';o.frequency.value=freq;
    const t=AC.currentTime+(delay||0);
    g.gain.setValueAtTime(vol||0.15,t);
    g.gain.exponentialRampToValueAtTime(0.001,t+dur);
    o.start(t);o.stop(t+dur+0.05);
  }catch(e){}
}

const SFX={
  step:()=>{if(Math.random()<0.25)playTone(60+Math.random()*20,'sine',.06,.04);},
  run:()=>{if(Math.random()<0.5){playTone(80+Math.random()*30,'sawtooth',.08,.07);}},
  pickup:()=>{playTone(440,'sine',.08,.2);playTone(660,'sine',.12,.18,.08);playTone(880,'sine',.15,.15,.18);},
  keys:()=>{playTone(350,'triangle',.06,.15);playTone(500,'triangle',.06,.12,.07);playTone(700,'triangle',.1,.1,.14);},
  unlock:()=>{for(let i=0;i<4;i++)playTone(300+i*120,'square',.05,.08,i*.06);},
  win:()=>{[523,659,784,1047].forEach((f,i)=>playTone(f,'sine',.2,.18,i*.12));},
  busted:()=>{playTone(300,'sawtooth',.08,.2);playTone(200,'sawtooth',.15,.18,.1);playTone(120,'sawtooth',.3,.15,.22);},
  chase:()=>{playTone(440,'square',.05,.1);playTone(380,'square',.05,.08,.08);},
  creak:()=>{playTone(180,'sawtooth',.12,.25);playTone(140,'sawtooth',.18,.15,.1);},
  snack:()=>{playTone(523,'sine',.06,.15);playTone(784,'sine',.1,.12,.08);},
  hide:()=>{playTone(220,'sine',.1,.1);},
  door:()=>{playTone(150,'triangle',.08,.1);playTone(120,'triangle',.12,.08,.06);},
  sleep:()=>{playTone(200,'sine',.2,.08);playTone(180,'sine',.3,.06,.15);},
  levelup:()=>{[392,494,587,784].forEach((f,i)=>playTone(f,'triangle',.15,.18,i*.1));},
  footstep:()=>{if(Math.random()<0.3)playTone(40+Math.random()*15,'sine',.05,.03);},
};

// ‚îÄ‚îÄ AVATAR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const SKINS=['#f5c5a3','#e8a878','#d4885a','#c06830','#8b4513','#5c2d0a'];
// Hair styles: null = bald, then 8 colour options
const HAIR_STYLES=[
  {id:'bald',  label:'Bald',    color:null},
  {id:'h1',    label:'Hair 1',  color:'#3a2210'},
  {id:'h2',    label:'Hair 2',  color:'#8b5a1a'},
  {id:'h3',    label:'Hair 3',  color:'#f5d376'},
  {id:'h4',    label:'Hair 4',  color:'#e84040'},
  {id:'h5',    label:'Hair 5',  color:'#a855f7'},
  {id:'h6',    label:'Hair 6',  color:'#60a5fa'},
  {id:'h7',    label:'Hair 7',  color:'#1e1e22'},
  {id:'h8',    label:'Hair 8',  color:'#ff9f43'},
];
// Outfits: first 3 free, rest unlock with coins (50 each)
const OUTFITS=[
  {id:'o1',label:'Pink',    color:'#e0507a',free:true},
  {id:'o2',label:'Blue',    color:'#5090e0',free:true},
  {id:'o3',label:'Green',   color:'#50c070',free:true},
  {id:'o4',label:'Orange',  color:'#e07050',free:false,cost:50},
  {id:'o5',label:'Purple',  color:'#9060d0',free:false,cost:50},
  {id:'o6',label:'Yellow',  color:'#e0c040',free:false,cost:50},
  {id:'o7',label:'Grey',    color:'#606060',free:false,cost:50},
  {id:'o8',label:'Cyan',    color:'#00cec9',free:false,cost:50},
  {id:'o9',label:'Red',     color:'#d63031',free:false,cost:50},
];
let unlockedOutfits=new Set(['o1','o2','o3']);

let avatar={skin:SKINS[0],hairId:'h1',outfitId:'o1',name:'KID'};
let avTemp={...avatar};

function hairColor(id){return (HAIR_STYLES.find(h=>h.id===id)||HAIR_STYLES[1]).color;}
function outfitColor(id){return (OUTFITS.find(o=>o.id===id)||OUTFITS[0]).color;}
// For drawing: resolve avatar to colours
function avColors(av){
  return {skin:av.skin, hair:hairColor(av.hairId), outfit:outfitColor(av.outfitId), name:av.name, hairId:av.hairId};
}

function showAvatarEditor(){
  avTemp={...avatar};
  document.getElementById('avName').value=avatar.name;
  buildSkinSwatches();
  buildHairSwatches();
  buildOutfitSwatches();
  renderAvPreview();
  updateCoinDisplay();
  document.getElementById('avEditor').classList.remove('hidden');
  // Scroll back to top
  const scroll=document.querySelector('.av-scroll');
  if(scroll)scroll.scrollTop=0;
}
function closeAvatarEditor(){document.getElementById('avEditor').classList.add('hidden');}
function saveAvatar(){
  avatar={...avTemp,name:document.getElementById('avName').value.toUpperCase()||'KID'};
  closeAvatarEditor();
}

function buildSkinSwatches(){
  const wrap=document.getElementById('skinSwatches');wrap.innerHTML='';
  SKINS.forEach((col,i)=>{
    const el=document.createElement('div');
    el.className='av-skin-sw'+(avTemp.skin===col?' sel':'');
    el.style.background=col;
    el.title='Skin Tone '+(i+1);
    el.onclick=()=>{avTemp.skin=col;buildSkinSwatches();renderAvPreview();};
    wrap.appendChild(el);
  });
}

function buildHairSwatches(){
  const wrap=document.getElementById('hairSwatches');wrap.innerHTML='';
  HAIR_STYLES.forEach(h=>{
    const sel=avTemp.hairId===h.id;
    const tile=document.createElement('div');
    tile.className='av-hair-tile'+(sel?' sel':'');
    // Color bar at top
    const bar=document.createElement('div');
    bar.className='av-hair-color-bar';
    if(h.color){
      bar.style.background=h.color;
    } else {
      // Bald ‚Äî scalp pattern
      bar.style.background='linear-gradient(135deg,#1e1e30 25%,#282848 25%,#282848 50%,#1e1e30 50%,#1e1e30 75%,#282848 75%)';
      bar.style.backgroundSize='8px 8px';
    }
    // Label at bottom
    const name=document.createElement('div');
    name.className='av-hair-name';
    name.textContent=h.label.toUpperCase();
    tile.appendChild(bar);
    tile.appendChild(name);
    tile.onclick=()=>{
      avTemp.hairId=h.id;
      buildHairSwatches();
      renderAvPreview();
      const lbEl=document.getElementById('hairLabel');
      if(lbEl)lbEl.textContent=h.label;
    };
    wrap.appendChild(tile);
  });
  // Sync label
  const cur=HAIR_STYLES.find(h=>h.id===avTemp.hairId)||HAIR_STYLES[1];
  const lbEl=document.getElementById('hairLabel');
  if(lbEl)lbEl.textContent=cur.label;
}

function buildOutfitSwatches(){
  const wrap=document.getElementById('outfitSwatches');wrap.innerHTML='';
  OUTFITS.forEach(o=>{
    const unlocked=o.free||unlockedOutfits.has(o.id);
    const sel=avTemp.outfitId===o.id;
    const el=document.createElement('div');
    el.className='av-outfit-sw'+(sel?' sel':'')+(unlocked?'':' av-locked');
    el.style.background=unlocked?o.color:o.color+'55';
    if(o.free){
      // FREE badge
      const fb=document.createElement('div');fb.className='av-free-badge';fb.textContent='FREE';
      el.appendChild(fb);
    } else if(!unlocked){
      // Lock overlay with coin cost
      const lk=document.createElement('div');lk.className='av-lock-label';
      lk.innerHTML='üîí<span>'+o.cost+'ü™ô</span>';
      el.appendChild(lk);
    }
    el.title=o.label+(unlocked?(o.free?' (Free)':''):' ‚Äî '+o.cost+' coins');
    el.onclick=()=>{
      if(!unlocked){
        if(coins>=o.cost){
          coins-=o.cost;
          unlockedOutfits.add(o.id);
          updateCoinDisplay();
          buildOutfitSwatches();
          toast('üéΩ '+o.label+' unlocked!','#00b894',220);
        } else {
          el.style.outline='2px solid #e74c3c';
          setTimeout(()=>el.style.outline='',700);
          toast('Not enough coins!','#e74c3c',220);
        }
        return;
      }
      avTemp.outfitId=o.id;
      buildOutfitSwatches();
      renderAvPreview();
    };
    wrap.appendChild(el);
  });
}

function renderAvPreview(){
  avTemp.name=document.getElementById('avName').value.toUpperCase()||'KID';
  const avc=document.getElementById('avc');const ctx2=avc.getContext('2d');
  ctx2.clearRect(0,0,110,110);
  ctx2.fillStyle='#0d0d1e';ctx2.fillRect(0,0,110,110);
  drawKidAt(ctx2,38,26,avColors(avTemp),2.2,false,false,0,'down');
  ctx2.fillStyle='rgba(255,255,255,0.7)';ctx2.font='bold 7px monospace';ctx2.textAlign='center';
  ctx2.fillText(avTemp.name,55,105);
}

function updateCoinDisplay(){
  document.querySelectorAll('.coin-display').forEach(el=>{
    if(el.classList.contains('coins-badge')||el.classList.contains('av-topbar-coins')){
      el.textContent='ü™ô '+coins+' coins';
    } else {
      el.textContent='ü™ô '+coins;
    }
  });
}

function showUpdateLog(){
  // Build log entries
  const box=document.getElementById('ulContent');
  if(!box)return;
  box.innerHTML='';
  UPDATE_LOG.forEach(entry=>{
    const wrap=document.createElement('div');
    wrap.className='ul-entry';
    const ver=document.createElement('div');ver.className='ul-ver';ver.textContent=entry.ver;
    const date=document.createElement('div');date.className='ul-date';date.textContent=entry.date;
    wrap.appendChild(ver);wrap.appendChild(date);
    entry.notes.forEach(n=>{
      const p=document.createElement('div');p.className='ul-note';p.textContent=n;
      wrap.appendChild(p);
    });
    box.appendChild(wrap);
  });
  // Update coin badge in log
  document.querySelectorAll('.coin-display').forEach(el=>el.textContent='ü™ô '+coins+' coins');
  document.getElementById('updateLog').classList.remove('hidden');
}

function drawKidAt(ctx,x,y,av,scale,hasPhone,hidden,walkFrame,facing,hasTablet){
  const s=scale||1;
  const W=Math.round(14*s),H=Math.round(18*s);
  const leg=[0,2,0,-2][walkFrame%4]*s;
  // drop shadow
  ctx.fillStyle='rgba(0,0,0,0.20)';ctx.fillRect(x+2*s,y+H+1,W-4*s,2*s);
  // legs
  const pantsCol=lighter(av.outfit,'-45');
  ctx.fillStyle=pantsCol;
  ctx.fillRect(x+2*s,y+H-7*s+leg,4*s,7*s);
  ctx.fillRect(x+W-6*s,y+H-7*s-leg,4*s,7*s);
  // shoes ‚Äî rounded pixel look
  ctx.fillStyle='#18181e';
  ctx.fillRect(x+1*s,y+H-2*s+leg,5*s,2*s);
  ctx.fillRect(x+W-6*s,y+H-2*s-leg,5*s,2*s);
  // body
  ctx.fillStyle=hasPhone?'#00b894':av.outfit;
  ctx.fillRect(x,y+5*s,W,H-12*s);
  // shirt highlight stripe
  ctx.fillStyle='rgba(255,255,255,0.12)';ctx.fillRect(x+1*s,y+5*s,W-2*s,2*s);
  // neck
  ctx.fillStyle=av.skin;ctx.fillRect(x+5*s,y+3*s,4*s,3*s);
  // head
  ctx.fillStyle=av.skin;
  ctx.fillRect(x+2*s,y-4*s,W-4*s,10*s);
  // subtle chin shadow
  ctx.fillStyle='rgba(0,0,0,0.08)';ctx.fillRect(x+3*s,y+4*s,W-6*s,2*s);
  // ‚îÄ‚îÄ HAIR ‚îÄ‚îÄ
  if(av.hair){
    // Hair top block
    ctx.fillStyle=av.hair;
    ctx.fillRect(x+2*s,y-5*s,W-4*s,5*s);
    // Side tufts
    ctx.fillRect(x+1*s,y-3*s,2*s,7*s);
    ctx.fillRect(x+W-3*s,y-3*s,2*s,7*s);
    // Fringe detail (darker shade)
    ctx.fillStyle=lighter(av.hair,'-25');
    ctx.fillRect(x+3*s,y-1*s,3*s,2*s);
    ctx.fillRect(x+W-6*s,y-1*s,3*s,2*s);
  }
  // ‚îÄ‚îÄ EYES ‚îÄ‚îÄ
  ctx.fillStyle='#1a1a22';
  if(facing==='left'){
    ctx.fillRect(x+1*s,y+1*s,2*s,2*s);
  } else if(facing==='right'){
    ctx.fillRect(x+W-3*s,y+1*s,2*s,2*s);
  } else {
    const ey=facing==='up'?(y-1*s):(y+1*s);
    ctx.fillRect(x+3*s,ey,2*s,2*s);
    ctx.fillRect(x+W-5*s,ey,2*s,2*s);
    // eye glint
    ctx.fillStyle='rgba(255,255,255,0.55)';
    ctx.fillRect(x+3*s,ey,1*s,1*s);
    ctx.fillRect(x+W-5*s,ey,1*s,1*s);
  }
  // ‚îÄ‚îÄ PIXEL PHONE (based on reference image) ‚îÄ‚îÄ
  if(hasPhone){
    // ‚îÄ‚îÄ PIXEL PHONE (matches reference: dark casing, blue screen, camera, home button) ‚îÄ‚îÄ
    const pw=Math.max(6,Math.round(7*s));
    const ph=Math.max(11,Math.round(13*s));
    const px=Math.round(x+W+s*0.5);
    const py=Math.round(y+3*s);
    const cx=Math.round(px+pw/2); // horizontal center

    // Shadow
    ctx.fillStyle='rgba(0,0,0,0.4)';
    ctx.fillRect(px+1,py+2,pw,ph);

    // Outermost pixel border ‚Äî very dark
    ctx.fillStyle='#1c1c1e';
    ctx.fillRect(px-1,py,pw+2,ph+1);

    // Main body ‚Äî dark charcoal (#3a3a3c like iPhone)
    ctx.fillStyle='#3a3a3c';
    ctx.fillRect(px,py,pw,ph);

    // Left edge highlight
    ctx.fillStyle='#555';
    ctx.fillRect(px,py+1,1,ph-2);
    // Right edge shadow
    ctx.fillStyle='#222';
    ctx.fillRect(px+pw-1,py+1,1,ph-2);

    // Bezel inside casing
    const bx=px+1,by=py+1,bw=pw-2,bh=ph-2;
    ctx.fillStyle='#2c2c2e';
    ctx.fillRect(bx,by,bw,bh);

    // Screen area
    const scr_top=Math.round(ph*0.14);
    const scr_bot=Math.round(ph*0.16);
    const sx=bx+1, sy=by+scr_top, sw=bw-2, sh=bh-scr_top-scr_bot;

    // Screen base ‚Äî rich blue
    ctx.fillStyle='#3a7fc1';
    ctx.fillRect(sx,sy,sw,sh);
    // Top half lighter sky blue
    ctx.fillStyle='#5baee8';
    ctx.fillRect(sx,sy,sw,Math.round(sh*0.5));
    // Glare diagonal ‚Äî top-left bright strip
    ctx.fillStyle='rgba(255,255,255,0.55)';
    ctx.fillRect(sx,sy,Math.round(sw*0.45),Math.round(sh*0.2));
    // Second glare line
    ctx.fillStyle='rgba(255,255,255,0.25)';
    ctx.fillRect(sx+1,sy+Math.round(sh*0.22),Math.round(sw*0.3),1);

    // Front camera dot ‚Äî top center of bezel
    ctx.fillStyle='#111';
    ctx.fillRect(cx-1,by+1,2,2);
    ctx.fillStyle='#2a2a2a';
    ctx.fillRect(cx,by+1,1,1);

    // Home button ‚Äî square with rounded feel (3-layer)
    const hby2=by+bh-Math.round(ph*0.11);
    ctx.fillStyle='#404044'; // outer ring
    ctx.fillRect(cx-3,hby2,6,Math.round(ph*0.08));
    ctx.fillStyle='#585860'; // inner ring
    ctx.fillRect(cx-2,hby2+1,4,Math.round(ph*0.08)-2);
    ctx.fillStyle='#6a6a70'; // center dot
    ctx.fillRect(cx-1,hby2+1,2,Math.round(ph*0.08)-2);
  }
  // ‚îÄ‚îÄ TABLET ‚îÄ‚îÄ
  if(hasTablet){
    ctx.fillStyle='#1a0a10';ctx.fillRect(x-3*s,y+6*s,7*s,11*s);
    ctx.fillStyle='#3d1a2e';ctx.fillRect(x-2*s,y+7*s,5*s,9*s);
    ctx.fillStyle='rgba(255,107,157,0.7)';ctx.fillRect(x-2*s,y+7*s,5*s,4*s);
  }
}

function darkerOutfit(c){return lighter(c,-50);}

function lighter(hex,amt){
  amt=parseInt(amt);
  if(isNaN(amt))return hex;
  try{const n=parseInt(hex.replace('#',''),16);const r=Math.min(255,Math.max(0,((n>>16)&255)+amt)),g=Math.min(255,Math.max(0,((n>>8)&255)+amt)),b=Math.min(255,Math.max(0,(n&255)+amt));return`#${((r<<16)|(g<<8)|b).toString(16).padStart(6,'0')}`;}catch(e){return hex;}
}

// ‚îÄ‚îÄ EARLY DECLARATIONS (needed before first use) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const GAME_VERSION='v1.5.0';
let coins=0;
let difficulty='medium'; // 'easy' | 'medium' | 'hard'
const UPDATE_LOG=[
  {ver:'v1.5.0',date:'Feb 2025',notes:[
    'Avatar Editor fully polished ‚Äî scrollable cards, large preview',
    'Pixel phone redesigned (camera dot, screen glare, home button)',
    '8 numbered hair styles + Bald option',
    'Outfit unlock system ‚Äî earn Bedtime Coins to unlock premium outfits',
    'Free skin badge shown in Avatar Editor',
    'Version badge tappable ‚Äî shows full update log',
    'Difficulty select screen before each run',
  ]},
  {ver:'v1.4.0',date:'Feb 2025',notes:[
    'Bedtime Coins ‚Äî earn 30 per completed level',
    'In-game coin display in HUD',
    'Coin total shown on win/game-over screens',
  ]},
  {ver:'v1.3.0',date:'Feb 2025',notes:[
    'Difficulty select: Easy / Medium / Hard',
    'Dad AI fully rebuilt ‚Äî no more door bugs',
    'Improved pathfinding with nav node cache & unstick logic',
    'Hearing range ‚Äî running is louder than walking',
    'Avatar Editor rebuilt with scrolling cards, no overlap',
  ]},
  {ver:'v1.2.0',date:'Feb 2025',notes:[
    'Level 6: THE FINAL NIGHT ‚Äî outdoor yard',
    'Family dog AI with patrol, sniff & chase states',
    'Red key + front door unlock mechanic',
    'Bush hiding spots in the yard',
    'PC keyboard overlay controls',
  ]},
  {ver:'v1.1.0',date:'Feb 2025',notes:[
    'Pause menu + Settings panel',
    'Control scheme selector (Mobile / PC)',
    'Mom character with independent sleep cycle',
    'Tablet pickup on Level 5',
    'Mobile layout fixes & responsive scaling',
  ]},
  {ver:'v1.0.0',date:'Feb 2025',notes:[
    '6 levels of sneaking',
    'Keys, locked doors, creaky floors',
    'Guard vision cones + chase AI',
    'Avatar customization',
    'Snacks, hiding spots, streaks',
  ]},
];

// ‚îÄ‚îÄ CANVAS & RESIZE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const canvas=document.getElementById('c');
const ctx=canvas.getContext('2d');
ctx.imageSmoothingEnabled=false;
const GW=480,GH=900;
// Responsive canvas scaling
function resizeCanvas(){
  const c=document.getElementById('c');
  const scaleX=window.innerWidth/GW;
  const scaleY=window.innerHeight/GH;
  const scale=Math.min(scaleX,scaleY);
  c.style.width=Math.floor(GW*scale)+'px';
  c.style.height=Math.floor(GH*scale)+'px';
  // Also reposition HUD and touch controls
  const hud=document.getElementById('hud');
  const tc=document.getElementById('tc');
  const pcCtrl=document.getElementById('pcCtrl');
  const w=Math.floor(GW*scale)+'px';
  if(hud){hud.style.width=w;hud.style.left='50%';hud.style.transform='translateX(-50%)';}
  if(tc){tc.style.width=w;tc.style.left='50%';tc.style.transform='translateX(-50%)';}
  if(pcCtrl){pcCtrl.style.left='50%';pcCtrl.style.transform='translateX(-50%)';}
}
window.addEventListener('resize',resizeCanvas);
window.addEventListener('orientationchange',()=>setTimeout(resizeCanvas,200));
resizeCanvas();
// Set version badge text from constant
const _vb=document.getElementById('verBadge');
if(_vb)_vb.textContent=GAME_VERSION;
function resize(){
  const gc=document.getElementById('gc');
  const s=Math.min(gc.clientWidth/GW,gc.clientHeight/GH,1);
  canvas.width=GW;canvas.height=GH;
  canvas.style.width=(GW*s)+'px';canvas.style.height=(GH*s)+'px';
}
window.addEventListener('resize',resize);resize();

// Stars on .sbg
document.querySelectorAll('.sbg').forEach(bg=>{
  for(let i=0;i<50;i++){
    const s=document.createElement('div');s.className='star';
    const sz=Math.random()*2+1;
    s.style.cssText=`width:${sz}px;height:${sz}px;left:${Math.random()*100}%;top:${Math.random()*100}%;--d:${2+Math.random()*4}s;--dl:${Math.random()*4}s;--op:${0.3+Math.random()*0.5};`;
    bg.appendChild(s);
  }
});

// ‚îÄ‚îÄ INPUT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let kd={},ti={dx:0,dy:0,run:false,act:false,active:false};
document.addEventListener('keydown',e=>{kd[e.key.toLowerCase()]=true;if(e.key===' ')e.preventDefault();resumeAC();});
document.addEventListener('keyup',e=>{kd[e.key.toLowerCase()]=false;});
document.addEventListener('keydown',e=>{
  if(e.key==='Escape'||e.key.toLowerCase()==='p'){if(gr||paused)togglePause();}
  if(e.key.toLowerCase()==='e'&&gr){doNearInteract();}
});

const joy=document.getElementById('joy'),jk=document.getElementById('jk');
let jc={x:0,y:0},jtid=null;
function ujc(){const r=joy.getBoundingClientRect();jc={x:r.left+r.width/2,y:r.top+r.height/2};}
joy.addEventListener('touchstart',e=>{e.preventDefault();resumeAC();ujc();const t=e.changedTouches[0];jtid=t.identifier;uj(t);},{passive:false});
joy.addEventListener('touchmove',e=>{e.preventDefault();for(let t of e.changedTouches)if(t.identifier===jtid){uj(t);break;}},{passive:false});
joy.addEventListener('touchend',e=>{e.preventDefault();for(let t of e.changedTouches)if(t.identifier===jtid){jtid=null;ti.dx=0;ti.dy=0;ti.active=false;jk.style.transform='';break;}},{passive:false});
joy.addEventListener('touchcancel',e=>{jtid=null;ti.dx=0;ti.dy=0;ti.active=false;jk.style.transform='';});
function uj(t){const m=28,dx=Math.min(Math.max(t.clientX-jc.x,-m),m),dy=Math.min(Math.max(t.clientY-jc.y,-m),m);jk.style.transform=`translate(${dx}px,${dy}px)`;ti.dx=dx/m;ti.dy=dy/m;ti.active=true;}
const rb=document.getElementById('rb'),ab=document.getElementById('ab');
rb.addEventListener('touchstart',e=>{e.preventDefault();ti.run=true;rb.classList.add('active');resumeAC();});
rb.addEventListener('touchend',e=>{e.preventDefault();ti.run=false;rb.classList.remove('active');});
rb.addEventListener('touchcancel',e=>{ti.run=false;rb.classList.remove('active');});
ab.addEventListener('touchstart',e=>{e.preventDefault();ti.act=true;ab.classList.add('active');resumeAC();if(gr)doNearInteract();});
ab.addEventListener('touchend',e=>{e.preventDefault();ti.act=false;ab.classList.remove('active');});

// ‚îÄ‚îÄ LEVEL DEFINITIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const LEVELS=[
    {num:1,name:'THE BASICS',moon:'üåô',
   tip:'Walk slowly ‚Äî running makes noise!',
   desc:'Sneak to the living room, grab your phone,\nand get back to bed before Dad sees you.',
   objectives:['üì± Grab the phone','üõèÔ∏è Back to your bed'],
   playerStart:{x:120,y:130},
   dad:{x:370,y:130,spd:0.72,rspd:1.2,vis:125,patrol:[
     {x:370,y:130},{x:415,y:80},{x:415,y:190},{x:370,y:190},
     {x:260,y:130},{x:260,y:320},
     {x:130,y:320},{x:80,y:320},{x:80,y:380},{x:130,y:380},
     {x:260,y:320},{x:260,y:510},
     {x:130,y:510},{x:80,y:510},{x:80,y:570},{x:130,y:570},
     {x:260,y:510},{x:260,y:130},
     {x:130,y:130},{x:80,y:80},{x:130,y:80},
     {x:260,y:130},{x:370,y:130},
   ],sleepIn:520},
   mom:null,
   phone:{x:130,y:510},
   keys:null,guestDoor:null,
   snack:{x:95,y:355,label:'üç™ SNACK -20% sleepiness'},
   creaks:[],lights:false,
  },
  {num:2,name:'LOCKED OUT',moon:'üîë',
   tip:'Find the keys in the kitchen ‚Äî then unlock the guest room.',
   desc:'Your phone got locked in the guest room.\nFind the keys first, then grab the phone.',
   objectives:['üîë Find the keys','üîì Unlock guest room','üì± Grab the phone','üõèÔ∏è Back to bed'],
   playerStart:{x:120,y:130},
   dad:{x:370,y:130,spd:0.82,rspd:1.3,vis:138,patrol:[
     {x:370,y:130},{x:415,y:80},{x:415,y:190},{x:370,y:190},
     {x:260,y:130},{x:260,y:320},
     {x:130,y:320},{x:80,y:290},{x:80,y:380},{x:130,y:380},
     {x:260,y:320},{x:260,y:130},
     {x:130,y:130},{x:80,y:80},{x:130,y:80},
     {x:260,y:130},{x:260,y:320},{x:260,y:510},
     {x:130,y:510},{x:80,y:510},{x:80,y:570},{x:130,y:570},
     {x:260,y:510},{x:260,y:320},
     {x:370,y:320},{x:415,y:280},{x:415,y:390},{x:370,y:390},
     {x:260,y:320},{x:260,y:130},{x:370,y:130},
   ],sleepIn:490},
   mom:null,
   phone:{x:400,y:470},
   keys:{x:155,y:395},
   guestDoor:{x:290,y:490,w:10,h:40},
   snack:{x:155,y:305,label:'ü•õ MILK -25% sleepiness'},
   creaks:[],lights:false,
  },
  {num:3,name:'CREAKY FLOORS',moon:'üò¨',
   tip:'Orange tiles creak! Step on one and Dad wakes instantly.',
   desc:'Watch the glowing floor tiles ‚Äî step on them\nand Dad comes running. Plan your route!',
   objectives:['üîë Find the keys','üîì Unlock guest room','üì± Grab the phone','üõèÔ∏è Back to bed'],
   playerStart:{x:120,y:130},
   dad:{x:260,y:320,spd:0.95,rspd:1.5,vis:145,patrol:[
     {x:260,y:320},{x:260,y:130},
     {x:130,y:130},{x:80,y:80},{x:130,y:80},
     {x:260,y:130},{x:370,y:130},{x:415,y:80},{x:415,y:190},{x:370,y:190},
     {x:260,y:130},{x:260,y:320},
     {x:370,y:320},{x:415,y:280},{x:415,y:390},{x:370,y:390},
     {x:260,y:320},{x:260,y:510},
     {x:130,y:510},{x:80,y:510},{x:80,y:570},{x:130,y:570},
     {x:260,y:510},{x:260,y:320},
     {x:130,y:320},{x:80,y:320},{x:80,y:380},{x:130,y:380},
     {x:260,y:320},
     {x:370,y:510},{x:415,y:480},{x:415,y:580},{x:360,y:580},
     {x:260,y:510},{x:260,y:320},
   ],sleepIn:440},
   mom:null,
   phone:{x:400,y:490},
   keys:{x:145,y:175},
   guestDoor:{x:290,y:490,w:10,h:40},
   snack:{x:62,y:465,label:'üçï PIZZA -30% sleepiness'},
   creaks:[{x:238,y:178,w:26,h:26},{x:138,y:308,w:26,h:26},{x:308,y:268,w:26,h:26},{x:198,y:468,w:26,h:26}],
   lights:false,
  },
  {num:4,name:'LIGHTS OUT',moon:'üåë',
   tip:'Lights flicker every 8 seconds. In the dark, sneak fast!',
   desc:'The house lights keep turning on and off.\nDad\'s vision doubles when lights are ON ‚Äî hide!',
   objectives:['üîë Find the keys','üîì Unlock guest room','üì± Grab the phone','üõèÔ∏è Back to bed'],
   playerStart:{x:120,y:130},
   dad:{x:370,y:510,spd:1.05,rspd:1.6,vis:118,patrol:[
     {x:370,y:510},{x:415,y:480},{x:415,y:580},{x:360,y:580},
     {x:260,y:510},{x:260,y:320},
     {x:130,y:320},{x:80,y:320},{x:80,y:380},{x:130,y:380},
     {x:260,y:320},{x:260,y:510},
     {x:130,y:510},{x:80,y:510},{x:80,y:570},{x:130,y:570},
     {x:260,y:510},{x:260,y:320},{x:260,y:130},
     {x:130,y:130},{x:80,y:80},{x:80,y:190},{x:130,y:190},
     {x:260,y:130},{x:370,y:130},{x:415,y:80},{x:415,y:190},{x:370,y:190},
     {x:260,y:130},{x:260,y:320},
     {x:370,y:320},{x:415,y:280},{x:415,y:390},{x:370,y:390},
     {x:260,y:320},{x:260,y:510},{x:370,y:510},
   ],sleepIn:390},
   mom:null,
   phone:{x:400,y:490},
   keys:{x:155,y:510},
   guestDoor:{x:290,y:490,w:10,h:40},
   snack:{x:158,y:263,label:'üßÉ JUICE -30% sleepiness'},
   creaks:[{x:98,y:228,w:26,h:26},{x:308,y:338,w:26,h:26}],
   lights:true,
  },
  {num:5,name:"MOM'S AWAKE",moon:'üíÄ',
   tip:'Both parents are up. Dad never sleeps. Good luck.',
   desc:'Dad AND Mom are both patrolling.\nGrab the phone AND the tablet ‚Äî both are in the guest room!',
   objectives:['üîë Find the keys','üîì Unlock guest room','üì± Grab the phone','üìü Grab the tablet','üõèÔ∏è Back to bed'],
   tablet:{x:420,y:490},
   playerStart:{x:120,y:130},
   dad:{x:370,y:130,spd:1.12,rspd:1.75,vis:152,patrol:[
     {x:370,y:130},{x:415,y:80},{x:415,y:190},{x:370,y:190},
     {x:260,y:130},{x:260,y:320},
     {x:370,y:320},{x:415,y:280},{x:415,y:390},{x:370,y:390},
     {x:260,y:320},{x:260,y:510},
     {x:370,y:510},{x:415,y:480},{x:415,y:580},{x:360,y:580},
     {x:260,y:510},{x:260,y:320},{x:260,y:130},{x:370,y:130},
   ],sleepIn:999999},
   mom:{x:130,y:510,spd:0.9,rspd:1.4,vis:128,sleepIn:280,patrol:[
     {x:130,y:510},{x:80,y:510},{x:80,y:570},{x:130,y:570},
     {x:260,y:510},{x:260,y:320},
     {x:130,y:320},{x:80,y:320},{x:80,y:380},{x:130,y:380},
     {x:260,y:320},{x:260,y:130},
     {x:130,y:130},{x:80,y:80},{x:80,y:190},{x:130,y:190},
     {x:260,y:130},{x:260,y:320},{x:260,y:510},{x:130,y:510},
   ]},
   phone:{x:400,y:490},
   keys:{x:145,y:175},
   guestDoor:{x:290,y:490,w:10,h:40},
   snack:{x:100,y:338,label:'‚òï COFFEE -40% sleepiness'},
   creaks:[{x:238,y:418,w:26,h:26}],
   lights:false,
  },
  {num:6,name:'THE FINAL NIGHT',moon:'üåø',
   tip:'Find the red key. Unlock the front door. Outsmart the dog. This is it.',
   desc:'THE FINAL LEVEL.\nYour phone is outside in the yard.\nBoth parents are awake. The family dog patrols the yard.\nFind the red key. Unlock the front door. Get the phone. Get back to bed.',
   objectives:['üî¥ Find the red key','üö™ Unlock the front door','üêï Sneak past the dog','üì± Grab the phone','üõèÔ∏è Back to your bed'],
   isFinal:true,
   playerStart:{x:120,y:130},
   dad:{x:370,y:130,spd:1.15,rspd:1.8,vis:155,patrol:[
     {x:370,y:130},{x:415,y:80},{x:415,y:190},{x:370,y:190},
     {x:260,y:130},{x:260,y:320},
     {x:370,y:320},{x:415,y:280},{x:415,y:390},{x:370,y:390},
     {x:260,y:320},{x:260,y:510},
     {x:130,y:510},{x:80,y:510},{x:80,y:570},{x:130,y:570},
     {x:260,y:510},{x:260,y:320},{x:260,y:130},{x:370,y:130},
   ],sleepIn:380},
   mom:{x:130,y:130,spd:0.95,rspd:1.45,vis:135,sleepIn:240,patrol:[
     {x:130,y:130},{x:80,y:80},{x:80,y:190},{x:130,y:190},
     {x:260,y:130},{x:260,y:320},
     {x:130,y:320},{x:80,y:320},{x:80,y:380},{x:130,y:380},
     {x:260,y:320},{x:260,y:510},
     {x:130,y:510},{x:80,y:510},{x:80,y:570},{x:130,y:570},
     {x:260,y:510},{x:260,y:320},{x:260,y:130},{x:130,y:130},
   ]},
   phone:{x:310,y:760},
   keys:{x:145,y:175},
   redKey:{x:62,y:455},
   guestDoor:{x:290,y:490,w:10,h:40},
   snack:{x:155,y:345,label:'‚òï COFFEE -40% sleepiness'},
   creaks:[{x:188,y:558,w:26,h:26},{x:308,y:178,w:26,h:26},{x:138,y:308,w:26,h:26}],
   lights:false,
   outdoor:true,
  },
];

// ‚îÄ‚îÄ MAP DATA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const ROOMS={
  yourRoom:  {x:40, y:40, w:180,h:180,floor:'#1e2235',grid:'#2a3050'},
  kitchen:   {x:40, y:240,w:180,h:160,floor:'#1a2230',grid:'#243040'},
  livingRoom:{x:40, y:420,w:180,h:180,floor:'#1c2030',grid:'#283048'},
  hallway:   {x:230,y:40, w:60, h:560,floor:'#111624',grid:'#1a2030'},
  parentsRm: {x:300,y:40, w:140,h:180,floor:'#1e1a30',grid:'#2a2440'},
  bathroom:  {x:300,y:240,w:140,h:160,floor:'#182830',grid:'#243840'},
  guestRoom: {x:300,y:420,w:140,h:180,floor:'#1c1a28',grid:'#282640'},
  // Lower floor ‚Äî accessible via stairwell in lower hallway
  lowerHall: {x:230,y:620,w:60, h:220,floor:'#0f1420',grid:'#18202e'},
  gameRoom:  {x:40, y:620,w:180,h:100,floor:'#12182a',grid:'#1c2840'},
  laundry:   {x:40, y:730,w:180,h:110,floor:'#101820',grid:'#182030'},
  storage:   {x:300,y:620,w:140,h:100,floor:'#14121e',grid:'#201a2c'},
  office:    {x:300,y:730,w:140,h:110,floor:'#0e1822',grid:'#182030'},
};
const WALLSDATA=[
  // Outer walls
  {x:0,y:0,w:480,h:30},{x:0,y:840,w:480,h:30},{x:0,y:0,w:30,h:870},{x:450,y:0,w:30,h:870},
  // Upper floor horizontal dividers
  {x:40,y:230,w:180,h:10},{x:40,y:410,w:180,h:10},{x:300,y:230,w:140,h:10},{x:300,y:410,w:140,h:10},
  // Upper floor vertical wall segments (left side of hallway, with gaps for doors)
  {x:220,y:40,w:10,h:70},{x:220,y:150,w:10,h:70},{x:220,y:240,w:10,h:60},{x:220,y:340,w:10,h:60},{x:220,y:420,w:10,h:70},{x:220,y:530,w:10,h:70},
  // Upper floor vertical wall segments (right side of hallway)
  {x:290,y:40,w:10,h:70},{x:290,y:150,w:10,h:70},{x:290,y:240,w:10,h:60},{x:290,y:340,w:10,h:60},{x:290,y:420,w:10,h:70},{x:290,y:530,w:10,h:70},
  // Floor divider between upper and lower floors (with a gap in hallway for stairs)
  {x:40,y:610,w:180,h:10},{x:300,y:610,w:140,h:10},
  // Lower floor horizontal dividers (game room / laundry split, storage / office split)
  {x:40,y:720,w:180,h:10},{x:300,y:720,w:140,h:10},
  // Lower floor vertical wall segments (left side of lower hallway)
  {x:220,y:620,w:10,h:70},{x:220,y:730,w:10,h:60},
  // Lower floor vertical wall segments (right side of lower hallway)
  {x:290,y:620,w:10,h:70},{x:290,y:730,w:10,h:60},
];
const FURN=[
  {x:60, y:60, w:80,h:100,type:'bed',    hide:true, col:'#2a4070'},
  {x:160,y:60, w:50,h:40, type:'desk',              col:'#5a3e28'},
  {x:60, y:180,w:40,h:30, type:'table',             col:'#4a3020'},
  {x:60, y:260,w:60,h:60, type:'fridge',            col:'#384448'},
  {x:130,y:260,w:80,h:40, type:'counter',           col:'#5a4038'},
  {x:60, y:340,w:70,h:50, type:'stove',             col:'#383c3e'},
  {x:60, y:440,w:100,h:60,type:'sofa',   hide:true, col:'#5a2230'},
  {x:60, y:520,w:60,h:60, type:'sofa',   hide:true, col:'#4a1820'},
  {x:170,y:460,w:40,h:50, type:'tv',                col:'#141618'},
  {x:120,y:520,w:50,h:40, type:'table',             col:'#4a3020'},
  {x:320,y:60, w:100,h:100,type:'bed',   hide:true, col:'#3a2460'},
  {x:320,y:180,w:60,h:30, type:'dresser',           col:'#4a2c18'},
  {x:390,y:180,w:40,h:30, type:'table',             col:'#3a2010'},
  {x:320,y:260,w:100,h:60,type:'tub',               col:'#1e3848'},
  {x:390,y:340,w:40,h:40, type:'toilet',            col:'#304040'},
  {x:320,y:340,w:50,h:40, type:'sink',              col:'#304048'},
  {x:320,y:440,w:60,h:80, type:'table',             col:'#4a3020'},
  {x:320,y:540,w:50,h:40, type:'cabinet',           col:'#3a2810'},
  {x:390,y:540,w:40,h:40, type:'chair',             col:'#5a2028'},
  // ‚îÄ‚îÄ LOWER FLOOR FURNITURE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Game Room (left)
  {x:60, y:635,w:80,h:50, type:'sofa',   hide:true, col:'#1a3a5a'},
  {x:150,y:635,w:50,h:35, type:'tv',                col:'#0a1020'},
  {x:60, y:695,w:40,h:30, type:'table',             col:'#2a1a0a'},
  {x:110,y:695,w:60,h:30, type:'cabinet',           col:'#2a1a12'},
  // Laundry Room (left-lower)
  {x:60, y:745,w:55,h:50, type:'washer',            col:'#1e3040'},
  {x:125,y:745,w:55,h:50, type:'dryer',             col:'#1e2838'},
  {x:60, y:800,w:60,h:30, type:'shelf',             col:'#2a1e10'},
  {x:130,y:800,w:70,h:30, type:'table',             col:'#241810'},
  // Storage Room (right)
  {x:315,y:635,w:50,h:40, type:'cabinet',           col:'#1a1428'},
  {x:375,y:635,w:50,h:40, type:'cabinet',           col:'#18121e'},
  {x:315,y:680,w:110,h:30,type:'shelf',             col:'#221a2e'},
  // Office (right-lower)
  {x:315,y:745,w:70,h:50, type:'desk',              col:'#1a2030'},
  {x:395,y:745,w:30,h:50, type:'chair',             col:'#1e1830'},
  {x:315,y:800,w:50,h:30, type:'cabinet',           col:'#181420'},
  {x:375,y:800,w:55,h:30, type:'table',             col:'#1c1828'},
];
const BASE_DOORS=[
  // Upper floor doors
  {x:220,y:110,w:10,h:40},{x:220,y:300,w:10,h:40},{x:220,y:490,w:10,h:40},
  {x:290,y:110,w:10,h:40},{x:290,y:300,w:10,h:40},
  // Lower floor doors
  {x:220,y:660,w:10,h:40},{x:220,y:760,w:10,h:40},
  {x:290,y:660,w:10,h:40},{x:290,y:760,w:10,h:40},
];

// ‚îÄ‚îÄ GAME STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let gr=false,gt=0,curLvl=0,streak=0,totalTime=0,lvlStart=0;
let paused=false;
// Settings
let settings={sfx:true,guardSpd:1.0,sleepRate:1.0,showVision:true};
// (GAME_VERSION, coins, difficulty, UPDATE_LOG declared earlier)
const DIFF_VIS={easy:-35,medium:0,hard:40}; // vision range delta
let walls=[],doors=[],guestDoor=null,creaks=[],lightOn=true,lightTimer=0;
let phone={x:0,y:0,w:12,h:14,col:false};
let tablet={x:0,y:0,w:18,h:14,col:false,exists:false};
let keyItem={x:0,y:0,w:14,h:10,col:false,exists:false};
let snack={x:0,y:0,w:14,h:12,col:false,exists:false,label:''};
let parts=[],floats=[],ccActive=false,ccTimer=0;
let shake={x:0,y:0,mag:0};
let sleep=0;
let objSt={keys:false,door:false,phone:false};
let redKey={x:0,y:0,w:14,h:10,col:false,exists:false};
let frontDoor={x:190,y:608,w:60,h:12,locked:true,ang:0};
let outdoor=false; // is level 6 outdoor zone unlocked
let dog={x:240,y:720,w:20,h:14,spd:0.7,rspd:1.4,state:'patrol',facing:0,
  pts:[{x:80,y:720},{x:200,y:750},{x:380,y:730},{x:420,y:780},{x:300,y:800},{x:120,y:790},{x:80,y:750}],
  cp:0,wt:0,wtt:0,wf:0,active:false,sc:0,ix:0,iy:0};
let chaseWarned=false;

const P={x:0,y:0,w:14,h:18,spd:1.2,rspd:2.0,vx:0,vy:0,hidden:false,hasPhone:false,hasTablet:false,hasKeys:false,hasRedKey:false,facing:'down',hideSpot:null,wf:0,wt:0};

function mkGuard(){return{x:0,y:0,w:16,h:20,spd:0.8,rspd:1.3,state:'patrol',pts:[],
  cp:0,wt:0,ix:0,iy:0,vis:140,vang:Math.PI/2.5,facing:0,running:false,wf:0,wtt:0,
  sleeping:false,st:0,sc:0,scLen:500,active:false,isMom:false};}
const DAD=mkGuard();
const MOM={...mkGuard(),isMom:true};

// Light canvas
const lc=document.createElement('canvas');lc.width=GW;lc.height=GH;
const lctx=lc.getContext('2d');
function glow(cx,cy,r,col){const g=lctx.createRadialGradient(cx,cy,0,cx,cy,r);g.addColorStop(0,col);g.addColorStop(1,'transparent');lctx.fillStyle=g;lctx.fillRect(cx-r,cy-r,r*2,r*2);}

// ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Wall check for player (respects door angle)
function cw(x,y,w,h){
  const bottomBound=outdoor?875:840;
  if(x<30||x+w>450||y<30||y+h>bottomBound)return true;
  for(let W of walls)if(x<W.x+W.w&&x+w>W.x&&y<W.y+W.h&&y+h>W.y)return true;
  for(let d of doors)if(d.ang<15&&x<d.x+d.w&&x+w>d.x&&y<d.y+d.h&&y+h>d.y)return true;
  if(guestDoor){
    if(guestDoor.locked&&x<guestDoor.x+guestDoor.w&&x+w>guestDoor.x&&y<guestDoor.y+guestDoor.h&&y+h>guestDoor.y)return true;
    if(!guestDoor.locked&&guestDoor.ang<15&&x<guestDoor.x+guestDoor.w&&x+w>guestDoor.x&&y<guestDoor.y+guestDoor.h&&y+h>guestDoor.y)return true;
  }
  return false;
}
// Wall check for guards (ignores door angle ‚Äî guards always push through doors)
function cwGuard(x,y,w,h){
  const bottomBound=LEVELS[curLvl]&&LEVELS[curLvl].outdoor?610:840;
  if(x<30||x+w>450||y<30||y+h>bottomBound)return true;
  for(let W of walls)if(x<W.x+W.w&&x+w>W.x&&y<W.y+W.h&&y+h>W.y)return true;
  // Guards only blocked by locked guest door
  if(guestDoor&&guestDoor.locked&&x<guestDoor.x+guestDoor.w&&x+w>guestDoor.x&&y<guestDoor.y+guestDoor.h&&y+h>guestDoor.y)return true;
  // Guards blocked by solid furniture (no clipping through objects!)
  for(let f of FURN){
    if(f.hide)continue; // guards can enter sofas/beds when searching
    if(x<f.x+f.w&&x+w>f.x&&y<f.y+f.h&&y+h>f.y)return true;
  }
  return false;
}
function col(a,b){return a.x<b.x+b.w&&a.x+a.w>b.x&&a.y<b.y+b.h&&a.y+a.h>b.y;}
function dst(x1,y1,x2,y2){return Math.sqrt((x2-x1)**2+(y2-y1)**2);}
function hideSpot(cx,cy){for(let f of FURN)if(f.hide&&cx>f.x+10&&cx<f.x+f.w-10&&cy>f.y+10&&cy<f.y+f.h-10)return f;return null;}
function nearDoor(cx,cy){
  for(let d of doors)if(Math.abs(cx-(d.x+d.w/2))<30&&cy>d.y-20&&cy<d.y+d.h+20)return d;
  if(guestDoor&&Math.abs(cx-(guestDoor.x+guestDoor.w/2))<30&&cy>guestDoor.y-20&&cy<guestDoor.y+guestDoor.h+20)return guestDoor;
  return null;
}
function guardSees(g){
  if(P.hidden||g.sleeping)return false;
  const lvl=LEVELS[curLvl];
  const vr=((lvl.lights&&lightOn)?g.vis+65:g.vis)+(DIFF_VIS[difficulty]||0);
  const dx=P.x-g.x,dy=P.y-g.y;
  if(dst(0,0,dx,dy)>vr)return false;
  for(let i=0;i<=14;i++){
    const t=i/14,cx=g.x+g.w/2+(P.x+P.w/2-g.x-g.w/2)*t,cy=g.y+g.h/2+(P.y+P.h/2-g.y-g.h/2)*t;
    for(let W of walls)if(cx>W.x&&cx<W.x+W.w&&cy>W.y&&cy<W.y+W.h)return false;
    for(let d of doors)if(d.ang<15&&cx>d.x&&cx<d.x+d.w&&cy>d.y&&cy<d.y+d.h)return false;
  }
  let angle=Math.atan2(dy,dx),diff=angle-g.facing;
  while(diff>Math.PI)diff-=Math.PI*2;while(diff<-Math.PI)diff+=Math.PI*2;
  return Math.abs(diff)<g.vang/2;
}
function doShake(m){shake.mag=Math.max(shake.mag,m);}
function toast(txt,col,y){
  const el=document.createElement('div');el.className='toast';el.textContent=txt;
  el.style.color=col||'#fdcb6e';el.style.top=(y||220)+'px';
  document.getElementById('gc').appendChild(el);setTimeout(()=>el.remove(),2100);
}
function floatTxt(t,x,y,c){floats.push({t,x,y,vy:-0.85,life:65,ml:65,c:c||'#fdcb6e'});}
function onYourBed(){const b=FURN[0];return P.x+P.w/2>b.x&&P.x+P.w/2<b.x+b.w&&P.y+P.h/2>b.y&&P.y+P.h/2<b.y+b.h;}

// ‚îÄ‚îÄ OBJECTIVES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildObjs(){
  const wrap=document.getElementById('objs');wrap.innerHTML='';
  LEVELS[curLvl].objectives.forEach((o,i)=>{
    const el=document.createElement('div');el.className='obj';el.id='ob'+i;el.textContent=o;wrap.appendChild(el);
  });updateObjs();
}
function updateObjs(){
  const lvl=LEVELS[curLvl];
  const hk=!!lvl.keys,hd=!!lvl.guestDoor,ht=!!lvl.tablet,ho=!!lvl.outdoor;
  let i=0;
  if(ho){
    // Level 6 flow: redKey ‚Üí frontDoor ‚Üí dog/outside ‚Üí phone ‚Üí bed
    setOb(i++,redKey.col?'done':redKey.exists?'active':'');
    setOb(i++,outdoor?'done':redKey.col?'active':'');
    setOb(i++,phone.col?'done':outdoor?'active':'');
    setOb(i++,phone.col?'done':outdoor?'active':'');
    setOb(i++,P.hasPhone?'active':'');
  } else if(hk){
    setOb(i++,P.hasKeys?'done':'active');
    if(hd)setOb(i++,objSt.door?'done':P.hasKeys?'active':'');
    const roomOpen=objSt.door||(!hd&&P.hasKeys);
    setOb(i++,phone.col?'done':roomOpen?'active':'');
    if(ht)setOb(i++,tablet.col?'done':roomOpen?'active':'');
    const allPickedUp=P.hasPhone&&(!ht||P.hasTablet);
    setOb(i,allPickedUp?'active':'');
  } else {
    setOb(i++,phone.col?'done':'active');
    setOb(i,P.hasPhone?'active':'');
  }
}
function setOb(i,s){const el=document.getElementById('ob'+i);if(el)el.className='obj'+(s?' '+s:'');}
function flashOb(i){
  const el=document.getElementById('ob'+i);if(!el)return;
  el.style.transform='scale(1.3)';el.style.color='#fff';
  setTimeout(()=>{el.style.transform='';updateObjs();},400);
}

// ‚îÄ‚îÄ LEVEL LOAD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function loadLevel(idx){
  curLvl=idx;const lvl=LEVELS[idx];
  walls=[...WALLSDATA];
  doors=BASE_DOORS.map(d=>({...d,open:true,ang:90}));
  if(lvl.guestDoor){guestDoor={...lvl.guestDoor,locked:true,open:false,ang:0};}
  else{guestDoor=null;doors.push({x:290,y:490,w:10,h:40,open:true,ang:90});}
  phone={x:lvl.phone.x,y:lvl.phone.y,w:12,h:14,col:false};
  keyItem=lvl.keys?{x:lvl.keys.x,y:lvl.keys.y,w:14,h:10,col:false,exists:true}:{exists:false,col:true};
  snack=lvl.snack?{x:lvl.snack.x,y:lvl.snack.y,w:14,h:12,col:false,exists:true,label:lvl.snack.label}:{exists:false,col:true};
  tablet=lvl.tablet?{x:lvl.tablet.x,y:lvl.tablet.y,w:18,h:14,col:false,exists:true}:{exists:false,col:true};
  creaks=lvl.creaks?[...lvl.creaks]:[];
  lightOn=true;lightTimer=0;
  redKey=lvl.redKey?{x:lvl.redKey.x,y:lvl.redKey.y,w:14,h:10,col:false,exists:true}:{exists:false,col:true};
  outdoor=false;
  frontDoor={x:190,y:608,w:60,h:12,locked:true,ang:0,open:false};
  dog.active=!!lvl.outdoor;
  if(lvl.outdoor){dog.x=240;dog.y=720;dog.state='patrol';dog.cp=0;dog.sc=0;dog.wt=0;}
  // DAD
  const ld=lvl.dad;
  Object.assign(DAD,{x:ld.x,y:ld.y,spd:ld.spd,rspd:ld.rspd,vis:ld.vis,pts:ld.patrol,
    state:'patrol',cp:0,wt:0,sleeping:false,st:0,sc:0,scLen:ld.sleepIn,running:false,wf:0,wtt:0,active:true,isMom:false});
  // MOM
  if(lvl.mom){
    const lm=lvl.mom;
    Object.assign(MOM,{x:lm.x,y:lm.y,spd:lm.spd,rspd:lm.rspd,vis:lm.vis,pts:lm.patrol,
      state:'patrol',cp:0,wt:0,sleeping:false,st:0,sc:0,scLen:lm.sleepIn||280,running:false,wf:0,wtt:0,active:true,isMom:true});
  } else {MOM.active=false;}
  // PLAYER
  P.x=lvl.playerStart.x;P.y=lvl.playerStart.y;
  P.hidden=false;P.hideSpot=null;P.hasPhone=false;P.hasTablet=false;P.hasRedKey=false;P.hasKeys=!lvl.keys;P.vx=0;P.vy=0;P.wf=0;
  sleep=0;parts=[];floats=[];ccActive=false;ccTimer=0;shake={x:0,y:0,mag:0};chaseWarned=false;
  objSt={keys:!lvl.keys,door:!lvl.guestDoor,phone:false};
  document.getElementById('lvlb').textContent='LVL '+lvl.num+' ‚Äî '+lvl.name;
  document.getElementById('strv').textContent=streak;
  buildObjs();
}

function showCard(){
  const lvl=LEVELS[curLvl];
  document.getElementById('lcmoon').textContent=lvl.moon;
  document.getElementById('lctitle').textContent='LEVEL '+lvl.num+': '+lvl.name;
  document.getElementById('lcsub').textContent=lvl.desc;
  document.getElementById('lctip').textContent='üí° '+lvl.tip;
  const ob=document.getElementById('lcobjs');ob.innerHTML='';
  lvl.objectives.forEach(o=>{const el=document.createElement('div');el.className='lcobj';el.textContent=o;ob.appendChild(el);});
  document.getElementById('lcard').classList.add('show');
}
function dismissCard(){
  document.getElementById('lcard').classList.remove('show');
  gr=true;lvlStart=gt;requestAnimationFrame(loop);
}

// ‚îÄ‚îÄ GAME FLOW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function startGame(){
  document.getElementById('ss').classList.add('hidden');
  document.getElementById('ws').classList.add('hidden');
  streak=0;totalTime=0;curLvl=0;
  loadLevel(0);showCard();
}
function retryLevel(){
  document.getElementById('go').classList.add('hidden');
  streak=0;document.getElementById('strv').textContent=0;
  loadLevel(curLvl);showCard();
}
function nextLevel(){
  document.getElementById('lw').classList.add('hidden');
  if(curLvl+1>=LEVELS.length){
    document.getElementById('wst').innerHTML=`total time: <em>${Math.round(totalTime/60)}s</em> &nbsp;|&nbsp; streak: <em>${streak}</em>`;
    document.getElementById('ws').classList.remove('hidden');
  } else {
    loadLevel(curLvl+1);showCard();
  }
}
function levelWin(){
  gr=false;streak++;SFX.levelup();
  const el=Math.floor((gt-lvlStart)/60);totalTime+=gt-lvlStart;
  // Award coins
  coins+=30;updateCoinDisplay();
  playTone(880,'sine',0.06,0.15);playTone(1100,'sine',0.08,0.12,0.07);
  document.getElementById('lwmoon').textContent=LEVELS[curLvl].moon;
  document.getElementById('lwtitle').textContent='LEVEL '+LEVELS[curLvl].num+' CLEAR!';
  document.getElementById('lwsub').textContent=curLvl+1<LEVELS.length?'The night gets harder...':'üåü ALL LEVELS BEATEN! You made it! Sweet dreams!';
  document.getElementById('lwst').innerHTML=`time: <em>${el}s</em> &nbsp;|&nbsp; streak: <em>${streak}</em> &nbsp;|&nbsp; ü™ô +30 coins`;
  document.getElementById('lw').classList.remove('hidden');
  document.getElementById('strv').textContent=streak;
  if(streak===3)toast('üî• 3 IN A ROW!','#e17055',180);
  if(streak===5)toast('üëë UNSTOPPABLE! x5','#ff6b9d',180);
}
function gameOver(r){
  gr=false;streak=0;doShake(9);SFX.busted();
  document.getElementById('dr').textContent=r;
  document.getElementById('go').classList.remove('hidden');
  document.getElementById('strv').textContent=0;
}

// ‚îÄ‚îÄ PAUSE & SETTINGS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function togglePause(){
  paused=!paused;gr=!paused;
  document.getElementById('pauseMenu').classList.toggle('hidden',!paused);
  if(!paused)requestAnimationFrame(loop);
}
function resumeGame(){paused=false;gr=true;document.getElementById('pauseMenu').classList.add('hidden');requestAnimationFrame(loop);}
function openSettings(){document.getElementById('settingsPanel').classList.remove('hidden');document.getElementById('pauseInner').classList.add('hidden');}
function closeSettings(){document.getElementById('settingsPanel').classList.add('hidden');document.getElementById('pauseInner').classList.remove('hidden');}
function setSfx(v){settings.sfx=v;document.getElementById('sfxBtn').textContent=v?'üîä ON':'üîá OFF';}
function setGuardSpd(v){settings.guardSpd=parseFloat(v);document.getElementById('gspdVal').textContent=['Slow','Normal','Fast','Nightmare'][Math.round((v-0.5)/0.5)]||'Normal';}
function setSleepRate(v){settings.sleepRate=parseFloat(v);document.getElementById('slrVal').textContent=['Easy','Normal','Hard','Brutal'][Math.round((v-0.5)/0.5)]||'Normal';}
function setVision(v){settings.showVision=v;document.getElementById('visBtn').textContent=v?'üëÅ ON':'üëÅ OFF';}
function showDiffSelect(){
  document.getElementById('ss').classList.add('hidden');
  document.getElementById('diffSelect').classList.remove('hidden');
  // Highlight current selection
  ['easy','medium','hard'].forEach(d=>{
    const el=document.getElementById('dopt-'+d);
    if(!el)return;
    const colors={easy:'rgba(0,184,148,.08)',medium:'rgba(162,155,254,.08)',hard:'rgba(231,76,60,.06)'};
    const borders={easy:'rgba(0,184,148,.3)',medium:'rgba(162,155,254,.35)',hard:'rgba(231,76,60,.25)'};
    if(d===difficulty){
      el.style.background=colors[d].replace('.0','.2');
      el.style.borderColor=d==='easy'?'#00b894':d==='medium'?'#a29bfe':'#e74c3c';
      el.style.transform='scale(1.02)';
    } else {
      el.style.background=colors[d];
      el.style.borderColor=borders[d];
      el.style.transform='';
    }
  });
}
function pickDiff(d){
  difficulty=d;
  document.getElementById('diffSelect').classList.add('hidden');
  startGame();
}
function quitToMenu(){paused=false;gr=false;document.getElementById('pauseMenu').classList.add('hidden');document.getElementById('go').classList.add('hidden');document.getElementById('lw').classList.add('hidden');document.getElementById('ss').classList.remove('hidden');}

let controlScheme='mobile';
function setControls(scheme){
  controlScheme=scheme;
  const mob=document.getElementById('ctrlMobile');
  const pcc=document.getElementById('ctrlPC');
  const tc=document.getElementById('tc');
  const pcCtrl=document.getElementById('pcCtrl');
  if(scheme==='mobile'){
    if(mob){mob.style.background='rgba(90,78,204,.25)';mob.style.borderColor='#a29bfe';mob.style.color='#a29bfe';}
    if(pcc){pcc.style.background='rgba(10,10,30,.4)';pcc.style.borderColor='rgba(162,155,254,.25)';pcc.style.color='#6070aa';}
    if(tc)tc.style.display='block';
    if(pcCtrl)pcCtrl.style.display='none';
  } else {
    if(pcc){pcc.style.background='rgba(90,78,204,.25)';pcc.style.borderColor='#a29bfe';pcc.style.color='#a29bfe';}
    if(mob){mob.style.background='rgba(10,10,30,.4)';mob.style.borderColor='rgba(162,155,254,.25)';mob.style.color='#6070aa';}
    if(tc)tc.style.display='none';
    if(pcCtrl)pcCtrl.style.display='flex';
  }
}

function pcPressE(){doNearInteract();}

function updatePCKeyVisuals(){
  const keys={'w':'kb-w','a':'kb-a','s':'kb-s','d':'kb-d','shift':'kb-shift',' ':'kb-space'};
  for(const[k,id] of Object.entries(keys)){
    const el=document.getElementById(id);
    if(el)el.classList.toggle('pressed',!!kd[k]);
  }
}

// ‚îÄ‚îÄ INTERACTION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function doNearInteract(){
  // Front door interaction for level 6
  if(outdoor===false&&LEVELS[curLvl].outdoor){
    const fd=frontDoor;
    const px=P.x+P.w/2,py=P.y+P.h/2;
    if(Math.abs(px-(fd.x+fd.w/2))<35&&Math.abs(py-(fd.y+fd.h/2))<30){
      if(fd.locked&&P.hasRedKey){
        fd.locked=false;fd.open=true;outdoor=true;dog.active=true;
        // Remove bottom wall so player can walk outside
        walls=walls.filter(w=>!(w.y===610&&w.h===30));
        SFX.unlock();playTone(200,'sine',0.15,0.12);playTone(300,'sine',0.12,0.10,0.1);playTone(400,'sine',0.10,0.08,0.2);
        toast('üö™ Front door open! Sneak outside...','#00b894',220);
        doShake(2.5);flashOb(1);updateObjs();
      } else if(fd.locked){
        toast('üî¥ Need the red key!','#e74c3c',220);doShake(1.5);
      }
      return;
    }
  }
}

// ‚îÄ‚îÄ UPDATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function update(){
  if(!gr)return;gt++;

  let ix=0,iy=0,run=false;
  if(kd['w']||kd['arrowup'])iy=-1;if(kd['s']||kd['arrowdown'])iy=1;
  if(kd['a']||kd['arrowleft'])ix=-1;if(kd['d']||kd['arrowright'])ix=1;
  if(kd['shift'])run=true;
  if(ti.active){ix=ti.dx;iy=ti.dy;}if(ti.run)run=true;
  if(ix||iy){const l=Math.sqrt(ix*ix+iy*iy);if(l>1){ix/=l;iy/=l;}}

  // Doors
  const nd=nearDoor(P.x+P.w/2,P.y+P.h/2);
  if(nd){
    if(nd===guestDoor){
      if(P.hasKeys&&guestDoor.locked){guestDoor.locked=false;guestDoor.open=true;
        if(!objSt.door){objSt.door=true;flashOb(1);toast('üîì DOOR UNLOCKED!','#00b894',200);SFX.unlock();}}
    } else {if(!nd.open){nd.open=true;SFX.door();}}
  }
  doors.forEach(d=>{const t=d.open?90:0;d.ang+=(t-d.ang)*0.15;});
  if(guestDoor&&!guestDoor.locked){const t=guestDoor.open?90:0;guestDoor.ang+=(t-guestDoor.ang)*0.15;}

  // Hide
  const hs=hideSpot(P.x+P.w/2,P.y+P.h/2)||(outdoor?bushHideSpot(P.x+P.w/2,P.y+P.h/2):null);
  if(hs&&(kd[' ']||ti.act)){if(!P.hidden)SFX.hide();P.hidden=true;P.hideSpot=hs;}
  else if(!kd[' ']&&!ti.act){P.hidden=false;P.hideSpot=null;}

  // Move
  const spd=P.hidden?0:(run?P.rspd:P.spd);
  P.vx=ix*spd;P.vy=iy*spd;
  if(Math.abs(ix)>Math.abs(iy))P.facing=ix>0?'right':'left';
  else if(iy)P.facing=iy>0?'down':'up';
  if(!P.hidden){
    let nx=P.x+P.vx;if(!cw(nx,P.y,P.w,P.h))P.x=nx;
    let ny=P.y+P.vy;if(!cw(P.x,ny,P.w,P.h))P.y=ny;
    for(let f of FURN)if(f.type!=='bed'&&col({x:P.x,y:P.y,w:P.w,h:P.h},f)){
      const cx=P.x+P.w/2-(f.x+f.w/2),cy=P.y+P.h/2-(f.y+f.h/2);
      if(Math.abs(cx)>Math.abs(cy))P.x+=cx>0?2:-2;else P.y+=cy>0?2:-2;
    }
    if(ix||iy){P.wt++;if(P.wt>8){P.wf=(P.wf+1)%4;P.wt=0;if(run)SFX.run();else SFX.step();}}
  }

  // Creaks
  for(let c of creaks){
    if(!P.hidden&&P.x+P.w>c.x&&P.x<c.x+c.w&&P.y+P.h>c.y&&P.y<c.y+c.h){
      SFX.creak();doShake(3);
      if(DAD.sleeping){DAD.sleeping=false;DAD.st=0;DAD.state='patrol';}
      if(DAD.state!=='chase'){DAD.state='investigate';DAD.ix=P.x;DAD.iy=P.y;}
      if(MOM.active&&MOM.state!=='chase'){MOM.state='investigate';MOM.ix=P.x;MOM.iy=P.y;}
      toast('üò¨ CREAK!','#e74c3c',235);
    }
  }

  // Lights
  if(LEVELS[curLvl].lights){
    lightTimer++;
    if(lightTimer>480){lightTimer=0;lightOn=!lightOn;
      if(lightOn){toast('üí° LIGHTS ON ‚Äî hide!','#fdcb6e',235);}
      else{toast('üåë Lights off ‚Äî move!','#a29bfe',235);}
    }
  }

  // Noise
  const loud=run&&(ix||iy);
  document.getElementById('ni').style.opacity=loud?1:0;
  if(loud&&DAD.sleeping){DAD.sleeping=false;DAD.st=0;DAD.state='patrol';toast('üò§ Noise woke Dad!','#e74c3c',225);}
  if(loud&&Math.random()<0.025&&DAD.state==='patrol'){DAD.state='investigate';DAD.ix=P.x;DAD.iy=P.y;}
  if(loud&&MOM.active&&Math.random()<0.025&&MOM.state==='patrol'){MOM.state='investigate';MOM.ix=P.x;MOM.iy=P.y;}

  // Sleepiness
  sleep+=0.0048+curLvl*0.0009;
  if(sleep>=100){gameOver('You fell asleep!');return;}
  document.getElementById('sf').style.width=sleep+'%';

  // Status
  const sv=document.getElementById('stv');
  if(P.hidden){sv.textContent='HIDING';sv.style.color='#00b894';}
  else if(run){sv.textContent='RUNNING';sv.style.color='#e74c3c';}
  else{sv.textContent='SNEAKING';sv.style.color='#74b9ff';}

  // Pickups
  if(keyItem.exists&&!keyItem.col&&dst(P.x+P.w/2,P.y+P.h/2,keyItem.x+7,keyItem.y+5)<28){
    keyItem.col=true;P.hasKeys=true;objSt.keys=true;SFX.keys();
    for(let i=0;i<14;i++)parts.push({x:keyItem.x+7,y:keyItem.y+5,vx:(Math.random()-.5)*6,vy:(Math.random()-.5)*6,life:50,col:['#fdcb6e','#f9ca24','#fff'][i%3],sz:5});
    toast('üîë KEYS FOUND!','#fdcb6e',195);floatTxt('+KEYS',keyItem.x,keyItem.y,'#fdcb6e');doShake(2.5);flashOb(0);updateObjs();
  }
  if(snack.exists&&!snack.col&&dst(P.x+P.w/2,P.y+P.h/2,snack.x+7,snack.y+6)<18){
    snack.col=true;SFX.snack();
    sleep=Math.max(0,sleep-(20+curLvl*5));
    for(let i=0;i<10;i++)parts.push({x:snack.x+7,y:snack.y+6,vx:(Math.random()-.5)*4,vy:(Math.random()-.5)*4,life:40,col:['#00b894','#55efc4'][i%2],sz:4});
    toast(snack.label,'#00b894',195);doShake(1.5);
  }
  if(!phone.col&&col(P,phone)){
    phone.col=true;P.hasPhone=true;objSt.phone=true;SFX.pickup();
    for(let i=0;i<22;i++)parts.push({x:phone.x+6,y:phone.y+7,vx:(Math.random()-.5)*7,vy:(Math.random()-.5)*7,life:60,col:['#fdcb6e','#74b9ff','#a29bfe','#00b894','#ff6b9d'][i%5],sz:5});
    toast('üì± GOT THE PHONE!','#74b9ff',195);floatTxt('+PHONE',phone.x,phone.y,'#74b9ff');doShake(3.5);
    const pi=LEVELS[curLvl].keys?2:0;flashOb(pi);updateObjs();
  }
  if(tablet.exists&&!tablet.col&&col(P,{x:tablet.x,y:tablet.y,w:tablet.w,h:tablet.h})){
    tablet.col=true;P.hasTablet=true;SFX.pickup();
    playTone(550,'sine',0.08,0.18);playTone(770,'sine',0.12,0.16,0.09);playTone(990,'sine',0.15,0.14,0.19);
    for(let i=0;i<24;i++)parts.push({x:tablet.x+9,y:tablet.y+7,vx:(Math.random()-.5)*7,vy:(Math.random()-.5)*7,life:65,col:['#fdcb6e','#ff6b9d','#a29bfe','#00b894','#ff9f43'][i%5],sz:5});
    toast('üìü GOT THE TABLET!','#ff6b9d',170);floatTxt('+TABLET',tablet.x,tablet.y,'#ff6b9d');doShake(4);
    const ti2=LEVELS[curLvl].keys?3:1;flashOb(ti2);updateObjs();
  }

  // Red key pickup
  if(redKey.exists&&!redKey.col&&dst(P.x+P.w/2,P.y+P.h/2,redKey.x+7,redKey.y+5)<28){
    redKey.col=true;P.hasRedKey=true;SFX.keys();
    playTone(280,'triangle',0.06,0.18);playTone(420,'triangle',0.08,0.15,0.07);
    for(let i=0;i<14;i++)parts.push({x:redKey.x+7,y:redKey.y+5,vx:(Math.random()-.5)*6,vy:(Math.random()-.5)*6,life:50,col:['#e74c3c','#ff6b6b','#fff'][i%3],sz:5});
    toast('üî¥ RED KEY found! Find the front door!','#e74c3c',195);floatTxt('+RED KEY',redKey.x,redKey.y,'#e74c3c');doShake(2.5);
    flashOb(0);updateObjs();
  }

  // Front door animation (level 6)
  if(LEVELS[curLvl].outdoor){
    const fd=frontDoor;
    const t2=fd.open?90:0;fd.ang+=(t2-fd.ang)*0.12;
    // Prompt when near
    const px2=P.x+P.w/2,py2=P.y+P.h/2;
    if(Math.abs(px2-(fd.x+fd.w/2))<40&&Math.abs(py2-(fd.y+fd.h/2))<35){
      if(fd.locked&&P.hasRedKey&&!outdoor)toast('Press E ‚Äî unlock front door','#fdcb6e',235);
      else if(fd.locked&&!P.hasRedKey)toast('üî¥ Locked ‚Äî need red key','#e74c3c',235);
    }
    // Dog AI
    if(dog.active)updateDog();
    // Dog catches player outside
    if(outdoor&&!P.hidden&&dst(P.x+P.w/2,P.y+P.h/2,dog.x+dog.w/2,dog.y+dog.h/2)<22){
      gameOver('The dog caught you!');return;
    }
  }

  // Win condition
  const bed=FURN[0];
  const needsTablet=!!LEVELS[curLvl].tablet;
  const needsOutdoor=!!LEVELS[curLvl].outdoor;
  const hasEverything=P.hasPhone&&(!needsTablet||P.hasTablet)&&(!needsOutdoor||phone.col);
  const onBed=P.x+P.w/2>bed.x&&P.x+P.w/2<bed.x+bed.w&&P.y+P.h/2>bed.y&&P.y+P.h/2<bed.y+bed.h;
  if(hasEverything&&onBed&&!P.hidden){
    SFX.win();levelWin();return;
  }
  // Reminder toasts
  if(onBed&&!P.hidden){
    if(P.hasPhone&&!P.hasTablet&&needsTablet)toast('üìü You forgot the tablet!','#ff6b9d',200);
    else if(needsOutdoor&&!phone.col)toast('üì± Get the phone from outside first!','#74b9ff',200);
  }

  // Guards AI
  updateGuard(DAD);
  if(MOM.active)updateGuard(MOM);

  // Bed safety
  const safe=onYourBed();
  if(safe){
    [DAD,MOM].forEach(g=>{if(g.active&&(g.state==='chase'||g.state==='investigate')){g.state='patrol';g.running=false;g.sc=0;}});
  } else {
    if(!P.hidden&&!DAD.sleeping&&guardSees(DAD)){
      if(DAD.state!=='chase'){SFX.chase();chaseWarned=false;}
      DAD.state='chase';DAD.running=true;
    }
    if(MOM.active&&!P.hidden&&guardSees(MOM)){
      if(MOM.state!=='chase')SFX.chase();
      MOM.state='chase';MOM.running=true;
    }
  }

  const dd=dst(P.x,P.y,DAD.x,DAD.y);
  if(!safe&&dd<20){gameOver('Dad caught you!');return;}
  if(MOM.active){const md=dst(P.x,P.y,MOM.x,MOM.y);if(!safe&&md<20){gameOver('Mom caught you!');return;}}

  // Close call
  const ccel=document.getElementById('cc');
  if(!safe&&dd<58&&!P.hidden){
    ccel.classList.add('danger');
    if(!ccActive){ccActive=true;ccTimer=0;doShake(1.5);}ccTimer++;
  } else {
    ccel.classList.remove('danger');
    if(ccActive&&ccTimer>30){toast('üòÖ CLOSE CALL!','#e17055',235);ccActive=false;}
    else ccActive=false;ccTimer=0;
  }

  // Dad chase sound pulse
  if(DAD.state==='chase'&&gt%60===0)SFX.chase();

  parts=parts.filter(p=>{p.x+=p.vx;p.y+=p.vy;p.vx*=0.9;p.vy*=0.9;p.life--;return p.life>0;});
  floats=floats.filter(f=>{f.y+=f.vy;f.life--;return f.life>0;});
  if(shake.mag>0.1){shake.x=(Math.random()-.5)*shake.mag;shake.y=(Math.random()-.5)*shake.mag;shake.mag*=0.82;}
  else{shake.x=0;shake.y=0;shake.mag=0;}
}

// ‚îÄ‚îÄ NAV GRAPH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// House layout: left rooms (x<220) | hallway (x 220-300) | right rooms (x>300)
// Walls divide columns. Door gaps are the only crossing points.
// Left wall (x=220) gap centers:  y=130, 320, 510
// Right wall (x=290) gap centers: y=130, 320, 510 (guest door, locked until unlocked)

// ‚îÄ‚îÄ NAV GRAPH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// House layout: left rooms (x<220) | hallway (x 220-300) | right rooms (x>300)
// Upper floor: y 40-610. Lower floor: y 620-840
// Wall gaps (doors) on lower floor at y‚âà680 and y‚âà780

const NAV={
  L80: {x:130,y:80},  L130:{x:130,y:130}, L200:{x:130,y:200},
  L280:{x:130,y:280}, L320:{x:130,y:320}, L380:{x:130,y:380},
  L460:{x:130,y:460}, L510:{x:130,y:510}, L570:{x:130,y:570},
  H80: {x:255,y:80},  H130:{x:255,y:130}, H200:{x:255,y:200},
  H280:{x:255,y:280}, H320:{x:255,y:320}, H420:{x:255,y:420},
  H510:{x:255,y:510}, H570:{x:255,y:570},
  R80: {x:370,y:80},  R130:{x:370,y:130}, R200:{x:370,y:200},
  R280:{x:370,y:280}, R320:{x:370,y:320}, R390:{x:370,y:390},
  R460:{x:370,y:460}, R510:{x:370,y:510}, R570:{x:370,y:570},
  // Door crossing waypoints upper floor
  DL1:{x:230,y:130}, DL2:{x:230,y:320}, DL3:{x:230,y:510},
  DR1:{x:292,y:130}, DR2:{x:292,y:320}, DR3:{x:292,y:510},
  // Lower floor nodes
  H630:{x:255,y:630}, H680:{x:255,y:680}, H760:{x:255,y:760}, H820:{x:255,y:820},
  L640:{x:130,y:640}, L700:{x:130,y:700}, L770:{x:130,y:770}, L820:{x:130,y:820},
  R640:{x:370,y:640}, R700:{x:370,y:700}, R770:{x:370,y:770}, R820:{x:370,y:820},
  // Lower floor door crossings
  DLL1:{x:230,y:680}, DLL2:{x:230,y:780},
  DRL1:{x:292,y:680}, DRL2:{x:292,y:780},
  // Stairwell connection (center hallway connects floors)
  STAIRS:{x:255,y:600},
};

const NAV_ADJ={
  L80:['L130'],       L130:['L80','L200','DL1'],   L200:['L130','L280'],
  L280:['L200','L320'],L320:['L280','L380','DL2'],  L380:['L320','L460'],
  L460:['L380','L510'],L510:['L460','L570','DL3'],  L570:['L510'],
  H80:['H130'],       H130:['H80','H200','DL1','DR1'],H200:['H130','H280'],
  H280:['H200','H320'],H320:['H280','H420','DL2','DR2'],H420:['H320','H510'],
  H510:['H420','H570','DL3','DR3'],H570:['H510','STAIRS'],
  R80:['R130'],       R130:['R80','R200','DR1'],    R200:['R130','R280'],
  R280:['R200','R320'],R320:['R280','R390','DR2'],  R390:['R320','R460'],
  R460:['R390','R510'],R510:['R460','R570','DR3'],  R570:['R510'],
  DL1:['L130','H130'],DL2:['L320','H320'],DL3:['L510','H510'],
  DR1:['R130','H130'],DR2:['R320','H320'],DR3:['R510','H510'],
  // Stairwell ‚Äî connects upper hallway bottom to lower hallway top
  STAIRS:['H570','H630'],
  // Lower hallway
  H630:['STAIRS','H680','DLL1','DRL1'], H680:['H630','H760'],
  H760:['H680','H820','DLL2','DRL2'],   H820:['H760'],
  // Lower left rooms
  L640:['L700','DLL1'], L700:['L640','L770'], L770:['L700','L820','DLL2'], L820:['L770'],
  // Lower right rooms
  R640:['R700','DRL1'], R700:['R640','R770'], R770:['R700','R820','DRL2'], R820:['R770'],
  // Lower door crossings
  DLL1:['L640','H630'], DLL2:['L770','H760'],
  DRL1:['R640','H630'], DRL2:['R770','H760'],
};

function xCol(x){return x<220?'L':x<300?'H':'R';}

function nearestNode(x,y,col){
  let best=null,bd=Infinity;
  for(const[id,n] of Object.entries(NAV)){
    if(col&&!id.startsWith(col))continue;
    const d=dst(x,y,n.x,n.y);
    if(d<bd){bd=d;best=id;}
  }
  return best;
}

// BFS with path caching
const _pathCache={};
function navPath(fromId,toId){
  const key=fromId+'|'+toId;
  if(_pathCache[key])return _pathCache[key];
  if(fromId===toId)return[toId];
  const visited={[fromId]:true};
  const queue=[[fromId,[fromId]]];
  while(queue.length){
    const[cur,path]=queue.shift();
    for(const nb of(NAV_ADJ[cur]||[])){
      if(visited[nb])continue;
      visited[nb]=true;
      const np=[...path,nb];
      if(nb===toId){_pathCache[key]=np;return np;}
      queue.push([nb,np]);
    }
  }
  return null;
}

// Returns the next {x,y} waypoint for a guard walking from (gx,gy) toward (tx,ty)
function navNextStep(gx,gy,tx,ty){
  const gc=xCol(gx),tc=xCol(tx);
  if(gc===tc){
    // Same column ‚Äî but still snap to a nav node Y if drifted too far off column center
    return{x:tx,y:ty};
  }
  const fromId=nearestNode(gx,gy);
  const toId=nearestNode(tx,ty);
  if(!fromId||!toId)return{x:tx,y:ty};
  const path=navPath(fromId,toId);
  if(!path||path.length<2)return{x:tx,y:ty};
  // Step through path: skip nodes we're already past (within 14px)
  for(let i=1;i<path.length;i++){
    const n=NAV[path[i]];
    if(!n)continue;
    if(dst(gx,gy,n.x,n.y)>14)return n;
  }
  return{x:tx,y:ty};
}

// Force all regular doors open near guard so they never get stuck
function guardOpenDoors(g){
  const cx=g.x+g.w/2,cy=g.y+g.h/2;
  for(const d of doors){
    if(dst(cx,cy,d.x+d.w/2,d.y+d.h/2)<90)d.open=true;
  }
}

function moveGuard(g,tx,ty,spd){
  guardOpenDoors(g);
  const step=navNextStep(g.x,g.y,tx,ty);
  const dx=step.x-(g.x+g.w/2), dy=step.y-(g.y+g.h/2);
  const d=Math.sqrt(dx*dx+dy*dy);
  if(d<1)return;
  const ux=dx/d, uy=dy/d;
  const nx=g.x+ux*spd, ny=g.y+uy*spd;
  // Try full move, then axis-separated fallbacks
  if     (!cwGuard(nx,ny,g.w,g.h)) { g.x=nx; g.y=ny; }
  else if(!cwGuard(nx,g.y,g.w,g.h)){ g.x=nx; }
  else if(!cwGuard(g.x,ny,g.w,g.h)){ g.y=ny; }
  else {
    // Truly jammed ‚Äî try small perpendicular nudge to escape
    const px=-uy, py=ux;
    if     (!cwGuard(g.x+px*spd,g.y+py*spd,g.w,g.h)){ g.x+=px*spd; g.y+=py*spd; }
    else if(!cwGuard(g.x-px*spd,g.y-py*spd,g.w,g.h)){ g.x-=px*spd; g.y-=py*spd; }
    // If still stuck, teleport toward nearest nav node to unstick
    else {
      const nn=NAV[nearestNode(g.x,g.y)];
      if(nn){ const dd=dst(g.x,g.y,nn.x,nn.y); if(dd>5){ g.x+=(nn.x-g.x)/dd*spd; g.y+=(nn.y-g.y)/dd*spd; }}
    }
  }
  g.facing=Math.atan2(uy,ux);
  g.wtt++; if(g.wtt>7){ g.wf=(g.wf+1)%4; g.wtt=0; SFX.footstep(); }
}

const ROOM_CENTERS=[
  {x:130,y:130},{x:130,y:320},{x:130,y:510},
  {x:255,y:320},
  {x:370,y:130},{x:370,y:320},{x:370,y:510},
  // Lower floor
  {x:130,y:665},{x:130,y:775},{x:370,y:665},{x:370,y:775},
];

function pickSearchTarget(g){
  const sorted=[...ROOM_CENTERS].sort((a,b)=>dst(g.ix,g.iy,a.x,a.y)-dst(g.ix,g.iy,b.x,b.y));
  return sorted.slice(0,3)[Math.floor(Math.random()*3)];
}

function updateGuard(g){
  if(!g.active)return;
  const baseSpd=g.spd*settings.guardSpd;

  // Sleeping ‚Äî count down then wake
  if(g.sleeping){
    g.st++;
    const dur=g.isMom?380:720;
    if(g.st>dur){
      g.sleeping=false; g.st=0; g.state='patrol';
      toast(`üëÅ ${g.isMom?'Mom':'Dad'} woke up!`,'#e74c3c',215);
    }
    return;
  }

  g.sc++;

  // ‚îÄ‚îÄ PATROL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if(g.state==='patrol'){
    g.running=false;
    // Time to sleep?
    if(g.sc>g.scLen){ g.state='goingTobed'; g.sc=0; return; }

    const pt=g.pts[g.cp];
    moveGuard(g,pt.x,pt.y,baseSpd);

    // Arrived at waypoint?
    if(dst(g.x+g.w/2,g.y+g.h/2,pt.x,pt.y)<16){
      g.wt++;
      const newRoom=whichRoom(pt.x,pt.y);
      const pauseLen=(g.lastRoom!==newRoom)?60:20;
      g.lastRoom=newRoom;
      // Scan left-right while waiting
      g.facing+=Math.sin(gt*0.05+g.cp*1.3)*0.03;
      if(g.wt>pauseLen){
        // Small chance to wander to a random waypoint (unpredictable)
        g.cp = (Math.random()<0.1&&g.pts.length>4)
          ? Math.floor(Math.random()*g.pts.length)
          : (g.cp+1)%g.pts.length;
        g.wt=0;
      }
    }

    // Hearing ‚Äî running player nearby triggers investigate
    const runNoise=(P.vx!==0||P.vy!==0)&&(kd['shift']||ti.run);
    const hearRange=runNoise?190:90; // running = louder
    if(!P.hidden&&dst(g.x,g.y,P.x,P.y)<hearRange){
      g.state='investigate'; g.ix=P.x; g.iy=P.y; g.sc=0; g.wt=0;
    }
    // Very close proximity ‚Äî always reacts regardless of vision angle
    if(!P.hidden&&dst(g.x,g.y,P.x,P.y)<55){
      g.state='investigate'; g.ix=P.x; g.iy=P.y; g.sc=0;
    }

  // ‚îÄ‚îÄ GOING TO BED ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  } else if(g.state==='goingTobed'){
    g.running=false;
    const bx=g.isMom?100:375, by=g.isMom?100:110;
    moveGuard(g,bx,by,baseSpd);
    if(dst(g.x,g.y,bx,by)<20){
      g.sleeping=true; g.st=0;
      toast(`üí§ ${g.isMom?'Mom':'Dad'} fell asleep!`,'#a29bfe',215); SFX.sleep();
    }
    // Distracted by nearby player while heading to bed
    if(!P.hidden&&dst(g.x,g.y,P.x,P.y)<100){
      g.state='investigate'; g.ix=P.x; g.iy=P.y; g.sc=0;
    }

  // ‚îÄ‚îÄ INVESTIGATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  } else if(g.state==='investigate'){
    g.running=false; g.sc=0;
    moveGuard(g,g.ix,g.iy,baseSpd*1.1);
    // Scan while near the investigation point
    if(dst(g.x+g.w/2,g.y+g.h/2,g.ix,g.iy)<24){
      g.wt++;
      g.facing+=Math.sin(gt*0.09+g.wt*0.1)*0.06; // sweep back and forth
      if(!g.searchTarget&&g.wt>50){
        g.searchTarget=pickSearchTarget(g); g.wt=0;
      } else if(g.searchTarget){
        moveGuard(g,g.searchTarget.x,g.searchTarget.y,baseSpd*0.9);
        if(dst(g.x+g.w/2,g.y+g.h/2,g.searchTarget.x,g.searchTarget.y)<22){
          g.searchTarget=null; g.wt=0; g.state='patrol';
        }
      } else if(g.wt>100){
        g.state='patrol'; g.wt=0;
      }
    }
    // Close enough while investigating ‚Üí chase
    if(!P.hidden&&dst(g.x,g.y,P.x,P.y)<45){
      g.state='chase'; g.running=true; g.searchTarget=null;
    }

  // ‚îÄ‚îÄ CHASE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  } else if(g.state==='chase'){
    g.running=true;
    const chaseSpd=g.rspd*settings.guardSpd;
    g.sc=0; g.searchTarget=null;
    // Force nearby doors open immediately
    const nd2=nearDoor(g.x+g.w/2,g.y+g.h/2);
    if(nd2&&nd2!==guestDoor)nd2.open=true;
    // Predictive intercept ‚Äî lead the player slightly
    let tx=P.x+P.w/2, ty=P.y+P.h/2;
    const pd=dst(g.x,g.y,P.x,P.y);
    if(pd>70){ tx+=P.vx*14; ty+=P.vy*14; }
    tx=Math.max(36,Math.min(444,tx));
    ty=Math.max(36,Math.min(604,ty));
    moveGuard(g,tx,ty,chaseSpd);
    // Lost player (hidden + distance) ‚Äî investigate last known pos
    if(P.hidden&&pd>130){
      g.state='investigate'; g.ix=P.x; g.iy=P.y;
      g.running=false; g.wt=0; g.searchTarget=null;
    }
  }
}

// Which named room is this point in?
function whichRoom(x,y){
  if(x<230){
    if(y<230)return'yourRoom';
    if(y<410)return'kitchen';
    return'living';
  }
  if(x<290)return'hall';
  if(y<230)return'parents';
  if(y<410)return'bath';
  return'guest';
}

// ‚îÄ‚îÄ DRAW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function drawRooms(){
  const dark=LEVELS[curLvl].lights&&!lightOn;
  const isOutdoor=!!LEVELS[curLvl].outdoor;
  for(const[key,r] of Object.entries(ROOMS)){
    // Hide lower floor rooms in outdoor level (the yard takes that space)
    const isLower=r.y>=620;
    if(isLower&&isOutdoor)continue;
    ctx.fillStyle=dark?'#090910':r.floor;ctx.fillRect(r.x,r.y,r.w,r.h);
    ctx.strokeStyle=r.grid;ctx.lineWidth=0.5;ctx.globalAlpha=0.28;
    for(let x=r.x;x<=r.x+r.w;x+=32){ctx.beginPath();ctx.moveTo(x,r.y);ctx.lineTo(x,r.y+r.h);ctx.stroke();}
    for(let y=r.y;y<=r.y+r.h;y+=32){ctx.beginPath();ctx.moveTo(r.x,y);ctx.lineTo(r.x+r.w,y);ctx.stroke();}
    ctx.globalAlpha=1;
  }
  // Draw stairwell connecting floors
  if(!isOutdoor){
    ctx.fillStyle='rgba(162,155,254,0.12)';ctx.fillRect(232,598,56,24);
    ctx.fillStyle='rgba(162,155,254,0.25)';ctx.font='bold 6px monospace';ctx.textAlign='center';
    ctx.fillText('‚ñº STAIRS ‚ñº',260,613);
    ctx.textAlign='left';ctx.font='bold 8px monospace';
  }
  ctx.fillStyle='rgba(255,255,255,0.11)';ctx.font='bold 8px monospace';ctx.textAlign='center';
  ctx.fillText('YOUR ROOM',130,208);ctx.fillText('KITCHEN',130,388);ctx.fillText('LIVING ROOM',130,584);
  ctx.fillText('HALL',260,325);ctx.fillText('PARENTS',370,208);ctx.fillText('BATH',370,388);ctx.fillText('GUEST ROOM',370,584);
  // Lower floor labels (hidden in outdoor level)
  if(!isOutdoor){
    ctx.fillStyle='rgba(100,130,200,0.18)';
    ctx.fillText('GAME ROOM',130,668);ctx.fillText('LAUNDRY',130,778);
    ctx.fillText('LOWER HALL',260,730);ctx.fillText('STORAGE',370,668);ctx.fillText('OFFICE',370,778);
  }
  ctx.textAlign='left';
}
function drawWalls(){
  walls.forEach(w=>{
    ctx.fillStyle='rgba(0,0,0,0.4)';ctx.fillRect(w.x+3,w.y+3,w.w,w.h);
    ctx.fillStyle='#0b0e1c';ctx.fillRect(w.x,w.y,w.w,w.h);
    ctx.fillStyle='rgba(255,255,255,0.045)';ctx.fillRect(w.x,w.y,w.w,3);ctx.fillRect(w.x,w.y,3,w.h);
  });
}
function drawDoor(d){
  ctx.fillStyle='#080c18';ctx.fillRect(d.x-3,d.y-3,d.w+6,d.h+6);
  const ang=d.ang*Math.PI/180;
  ctx.save();ctx.translate(d.x+d.w/2,d.y+d.h/2);ctx.scale(Math.cos(ang),1);
  ctx.fillStyle=d.ang>45?'#4a3428':'#281a0c';ctx.fillRect(-d.w/2,-d.h/2,d.w,d.h);
  ctx.fillStyle='rgba(255,255,255,0.07)';ctx.fillRect(-d.w/2+1,-d.h/2+1,d.w-2,d.h/3);
  ctx.fillStyle='#c8a040';ctx.fillRect(d.w/2-5,-3,4,6);ctx.restore();
}
function drawGuestDoor(){
  if(!guestDoor)return;const d=guestDoor;
  ctx.fillStyle='#080c18';ctx.fillRect(d.x-3,d.y-3,d.w+6,d.h+6);
  if(d.locked){
    ctx.fillStyle='#2a100a';ctx.fillRect(d.x,d.y,d.w,d.h);
    const lp=Math.abs(Math.sin(gt*0.05))*0.35+0.15;
    ctx.fillStyle=`rgba(200,50,30,${lp})`;ctx.fillRect(d.x,d.y,d.w,d.h);
    ctx.fillStyle='#c84020';ctx.fillRect(d.x+1,d.y+d.h/2-3,d.w-2,8);
    ctx.strokeStyle='#c84020';ctx.lineWidth=1.5;
    ctx.beginPath();ctx.arc(d.x+d.w/2,d.y+d.h/2-4,3,Math.PI,0);ctx.stroke();
  } else {
    const ang=d.ang*Math.PI/180;
    ctx.save();ctx.translate(d.x+d.w/2,d.y+d.h/2);ctx.scale(Math.cos(ang),1);
    ctx.fillStyle=d.ang>45?'#4a3428':'#281a0c';ctx.fillRect(-d.w/2,-d.h/2,d.w,d.h);
    ctx.fillStyle='rgba(255,255,255,0.07)';ctx.fillRect(-d.w/2+1,-d.h/2+1,d.w-2,d.h/3);
    ctx.fillStyle='#c8a040';ctx.fillRect(d.w/2-5,-3,4,6);ctx.restore();
  }
}
function drawFurn(f){
  ctx.fillStyle='rgba(0,0,0,0.3)';ctx.fillRect(f.x+4,f.y+5,f.w,f.h);
  ctx.fillStyle=f.col;ctx.fillRect(f.x,f.y,f.w,f.h);
  ctx.fillStyle='rgba(255,255,255,0.08)';ctx.fillRect(f.x,f.y,f.w,3);ctx.fillRect(f.x,f.y,3,f.h);
  ctx.fillStyle='rgba(0,0,0,0.2)';ctx.fillRect(f.x,f.y+f.h-3,f.w,3);ctx.fillRect(f.x+f.w-3,f.y,3,f.h);
  if(f.type==='bed'){
    ctx.fillStyle='#e8e0f2';ctx.fillRect(f.x+7,f.y+7,f.w-14,20);
    ctx.fillStyle='rgba(255,255,255,0.18)';ctx.fillRect(f.x+9,f.y+9,f.w-18,5);
    ctx.fillStyle=lighter(f.col,'28');ctx.fillRect(f.x+7,f.y+30,f.w-14,f.h-38);
    ctx.fillStyle='rgba(0,0,0,0.1)';for(let i=13;i<f.w-13;i+=13)ctx.fillRect(f.x+i,f.y+32,2,f.h-42);
  } else if(f.type==='desk'){
    ctx.fillStyle='#040810';ctx.fillRect(f.x+7,f.y+5,30,22);
    ctx.fillStyle='#182840';ctx.fillRect(f.x+9,f.y+7,26,18);
    ctx.fillStyle='rgba(80,140,255,0.22)';ctx.fillRect(f.x+9,f.y+7,26,5);
  } else if(f.type==='sofa'){
    ctx.fillStyle='rgba(255,255,255,0.06)';ctx.fillRect(f.x+4,f.y+f.h/2,f.w-8,f.h/2-4);
  } else if(f.type==='tv'){
    ctx.fillStyle='rgba(50,90,220,0.2)';ctx.fillRect(f.x+4,f.y+5,f.w-8,f.h-10);
  } else if(f.type==='stove'){
    for(const bx of[f.x+18,f.x+f.w-22])for(const by of[f.y+16,f.y+f.h-18]){
      ctx.fillStyle='#3a1e0c';ctx.beginPath();ctx.arc(bx,by,7,0,Math.PI*2);ctx.fill();
      ctx.fillStyle='#1e0c04';ctx.beginPath();ctx.arc(bx,by,4,0,Math.PI*2);ctx.fill();
    }
  } else if(f.type==='tub'){
    ctx.fillStyle='rgba(80,180,255,0.12)';ctx.fillRect(f.x+8,f.y+12,f.w-16,f.h-20);
  } else if(f.type==='fridge'){
    ctx.fillStyle='rgba(255,255,255,0.07)';ctx.fillRect(f.x+5,f.y+5,f.w-10,18);
  }
  if(f.hide){ctx.strokeStyle='rgba(0,184,148,0.18)';ctx.lineWidth=1.5;ctx.strokeRect(f.x+1,f.y+1,f.w-2,f.h-2);}
}
function drawCreaks(){
  for(let c of creaks){
    const p=Math.abs(Math.sin(gt*0.055))*0.35+0.2;
    ctx.fillStyle=`rgba(255,175,0,${p})`;ctx.fillRect(c.x,c.y,c.w,c.h);
    ctx.fillStyle=`rgba(255,210,0,${p*0.5})`;ctx.fillRect(c.x+5,c.y+5,c.w-10,c.h-10);
    ctx.fillStyle=`rgba(255,200,50,${p+0.2})`;ctx.font='9px monospace';ctx.textAlign='center';
    ctx.fillText('!',c.x+c.w/2,c.y+c.h/2+4);ctx.textAlign='left';
  }
}
function drawKeys(){
  if(!keyItem.exists||keyItem.col)return;
  const kx=keyItem.x,ky=keyItem.y;
  const g2=Math.sin(gt*0.09)*0.15+0.25;
  const gr2=ctx.createRadialGradient(kx+7,ky+5,0,kx+7,ky+5,20);
  gr2.addColorStop(0,`rgba(253,203,110,${g2+0.15})`);gr2.addColorStop(1,'transparent');
  ctx.fillStyle=gr2;ctx.fillRect(kx-13,ky-13,40,40);
  ctx.strokeStyle='#c8a040';ctx.lineWidth=2;
  ctx.beginPath();ctx.arc(kx+4,ky+5,4,0,Math.PI*2);ctx.stroke();
  ctx.fillStyle='#d4a820';ctx.fillRect(kx+6,ky+4,8,2);
  ctx.fillRect(kx+9,ky+6,2,2);ctx.fillRect(kx+12,ky+6,2,2);
}
function drawSnack(){
  if(!snack.exists||snack.col)return;
  const p=Math.abs(Math.sin(gt*0.07))*0.2+0.25;
  const gr2=ctx.createRadialGradient(snack.x+7,snack.y+6,0,snack.x+7,snack.y+6,18);
  gr2.addColorStop(0,`rgba(0,184,148,${p})`);gr2.addColorStop(1,'transparent');
  ctx.fillStyle=gr2;ctx.fillRect(snack.x-11,snack.y-11,36,36);
  ctx.font='12px serif';ctx.textAlign='center';
  ctx.fillText(snack.label.split(' ')[0],snack.x+7,snack.y+12);ctx.textAlign='left';
}
function drawPhone(){
  if(phone.col)return;
  const px=phone.x,py=phone.y,g2=Math.sin(gt*0.07)*0.18+0.28;
  const grad=ctx.createRadialGradient(px+6,py+7,0,px+6,py+7,24);
  grad.addColorStop(0,`rgba(80,180,255,${g2})`);grad.addColorStop(1,'transparent');
  ctx.fillStyle=grad;ctx.fillRect(px-18,py-18,48,48);
  ctx.fillStyle='#0e0e0e';ctx.fillRect(px,py,phone.w,phone.h);
  ctx.fillStyle='#1a1a1e';ctx.fillRect(px+1,py+1,phone.w-2,phone.h-2);
  ctx.fillStyle='#4090e0';ctx.fillRect(px+2,py+3,phone.w-4,phone.h-6);
  ctx.fillStyle='rgba(255,255,255,0.28)';ctx.fillRect(px+2,py+3,phone.w-4,3);
}
function drawTablet(){
  if(!tablet.exists||tablet.col)return;
  const tx=tablet.x,ty=tablet.y,g2=Math.sin(gt*0.065)*0.2+0.3;
  // Outer glow ‚Äî pink/purple to distinguish from phone's blue
  const grad=ctx.createRadialGradient(tx+9,ty+7,0,tx+9,ty+7,28);
  grad.addColorStop(0,`rgba(255,107,157,${g2})`);grad.addColorStop(1,'transparent');
  ctx.fillStyle=grad;ctx.fillRect(tx-19,ty-19,56,52);
  // Tablet body ‚Äî wider than phone
  ctx.fillStyle='#1a0a10';ctx.fillRect(tx,ty,tablet.w,tablet.h);
  ctx.fillStyle='#221218';ctx.fillRect(tx+1,ty+1,tablet.w-2,tablet.h-2);
  // Screen
  ctx.fillStyle='#3d1a2e';ctx.fillRect(tx+2,ty+2,tablet.w-4,tablet.h-4);
  // Screen glow / content
  const sg=Math.abs(Math.sin(gt*0.04))*0.25+0.1;
  ctx.fillStyle=`rgba(255,107,157,${sg})`;ctx.fillRect(tx+2,ty+2,tablet.w-4,tablet.h-4);
  // Fake app icons on screen
  ctx.fillStyle='rgba(255,180,210,0.5)';
  ctx.fillRect(tx+3,ty+3,4,4);ctx.fillRect(tx+8,ty+3,4,4);ctx.fillRect(tx+13,ty+3,4,4);
  ctx.fillRect(tx+3,ty+8,4,4);ctx.fillRect(tx+8,ty+8,4,4);
  // Home button circle
  ctx.strokeStyle='rgba(255,150,180,0.6)';ctx.lineWidth=1;
  ctx.beginPath();ctx.arc(tx+tablet.w/2,ty+tablet.h-2,1.5,0,Math.PI*2);ctx.stroke();
  // Bounce animation
  const bounce=Math.sin(gt*0.07)*2;
  ctx.fillStyle='rgba(255,107,157,0.18)';
  ctx.fillRect(tx-1,ty+tablet.h+2+bounce,tablet.w+2,2);
}

function drawPlayer(){
  const x=Math.round(P.x),y=Math.round(P.y);
  if(P.hidden&&P.hideSpot){
    const hy=P.hideSpot.y+P.hideSpot.h-10;
    ctx.fillStyle=avatar.skin;ctx.fillRect(x+2,hy,10,7);
    ctx.fillStyle='#fff';ctx.fillRect(x+3,hy+1,3,3);ctx.fillRect(x+8,hy+1,3,3);
    ctx.fillStyle='#222';ctx.fillRect(x+4,hy+2,1,2);ctx.fillRect(x+9,hy+2,1,2);
    return;
  }
  ctx.fillStyle='rgba(0,0,0,0.22)';ctx.beginPath();ctx.ellipse(x+P.w/2,y+P.h+1,7,3,0,0,Math.PI*2);ctx.fill();
  drawKidAt(ctx,x,y,avColors(avatar),1,P.hasPhone,false,P.wf,P.facing,P.hasTablet);
  // Name tag
  ctx.fillStyle='rgba(255,255,255,0.55)';ctx.font='5px monospace';ctx.textAlign='center';
  ctx.fillText(avatar.name,x+P.w/2,y-7);ctx.textAlign='left';
}
function drawGuard(g,isMom){
  if(!g.active)return;
  const x=Math.round(g.x),y=Math.round(g.y);
  const alert=g.state==='chase',goingBed=g.state==='goingTobed'&&!g.sleeping;
  const leg=[0,2,0,-2][g.wf];
  ctx.fillStyle='rgba(0,0,0,0.22)';ctx.beginPath();ctx.ellipse(x+g.w/2,y+g.h+1,8,3,0,0,Math.PI*2);ctx.fill();
  // Legs
  ctx.fillStyle=alert?'#5a0000':isMom?'#3a1040':'#164870';
  ctx.fillRect(x+2,y+g.h-9+leg,5,9);ctx.fillRect(x+g.w-7,y+g.h-9-leg,5,9);
  // Body / robe
  const bodyCol=alert?'#b03020':goingBed?'#354050':isMom?'#701080':'#2070a0';
  ctx.fillStyle=bodyCol;ctx.fillRect(x,y+6,g.w,g.h-13);
  ctx.fillStyle='rgba(255,255,255,0.06)';ctx.fillRect(x,y+6,g.w,4);
  ctx.fillStyle=alert?'#6a1008':isMom?'#4a0060':'#104060';ctx.fillRect(x,y+16,g.w,3);
  // Head
  ctx.fillStyle=isMom?'#e8b098':'#e8a878';ctx.fillRect(x+2,y-5,g.w-4,13);
  ctx.fillStyle=isMom?'#8b3a6a':'#686868';ctx.fillRect(x+2,y-5,g.w-4,2);
  ctx.fillRect(x-1,y-3,3,5);ctx.fillRect(x+g.w-2,y-3,3,5);
  // Eyes
  ctx.fillStyle=alert?'#ff1010':'#1e1e22';
  const ex=x+g.w/2+Math.cos(g.facing)*4,ey=y+1+Math.sin(g.facing);
  ctx.fillRect(ex-4,ey-2,8,5);
  if(alert){ctx.fillStyle='rgba(255,0,0,0.12)';ctx.beginPath();ctx.arc(x+g.w/2,y+5,20,0,Math.PI*2);ctx.fill();}
  // Flashlight handle
  ctx.fillStyle=isMom?'#906090':'#707070';ctx.fillRect(x+g.w-2,y+8,4,12);
  // Indicators
  if(g.sleeping){
    ctx.fillStyle='#e8a878';ctx.fillRect(ex-4,ey-2,8,5);
    ctx.fillStyle='#3a2210';ctx.fillRect(ex-3,ey,6,2);
    const zp=gt*0.04;
    [[9,0,0],[7,12,0],[5,22,0]].forEach(([sz,ox,],i)=>{
      const zx=x+g.w+4+ox+Math.sin(zp+i)*2,zy=y-8-ox*0.8-Math.abs(Math.sin(zp*0.5+i))*5;
      ctx.fillStyle=`rgba(162,155,254,${0.9-i*0.25})`;ctx.font=`bold ${sz}px monospace`;
      ctx.textAlign='left';ctx.fillText('z',zx,zy);
    });ctx.textAlign='left';
  } else if(alert){
    ctx.fillStyle='#ff2020';ctx.fillRect(x+g.w/2-2,y-22,4,11);ctx.fillRect(x+g.w/2-2,y-8,4,4);
  } else if(g.state==='investigate'){
    ctx.fillStyle='#e0c020';ctx.fillRect(x+g.w/2-2,y-20,4,10);ctx.fillRect(x+g.w/2-2,y-7,4,4);
  } else if(goingBed){
    ctx.fillStyle='rgba(162,155,254,0.65)';ctx.font='bold 8px monospace';
    ctx.fillText('z',x+g.w+2,y-4+Math.sin(gt*0.05)*2);
  }
  // Label
  ctx.fillStyle='rgba(255,255,255,0.35)';ctx.font='5px monospace';ctx.textAlign='center';
  ctx.fillText(isMom?'MOM':'DAD',x+g.w/2,y-9);ctx.textAlign='left';
}
function drawVision(g){
  if(g.state==='chase'||g.sleeping||!g.active)return;
  const lvl=LEVELS[curLvl];
  const vr=((lvl.lights&&lightOn)?g.vis+65:g.vis)+(DIFF_VIS[difficulty]||0);
  ctx.save();ctx.globalAlpha=g.isMom?0.05:0.06;ctx.fillStyle=g.isMom?'#ff80ff':'#ffe840';
  ctx.beginPath();ctx.moveTo(g.x+g.w/2,g.y+g.h/2);
  ctx.arc(g.x+g.w/2,g.y+g.h/2,vr,g.facing-g.vang/2,g.facing+g.vang/2);
  ctx.closePath();ctx.fill();ctx.restore();
}
function drawLighting(){
  lctx.clearRect(0,0,GW,GH);
  glow(P.x+P.w/2,P.y+P.h/2,78,'rgba(190,150,90,0.1)');
  function guardGlow(g){
    if(!g.active||g.sleeping)return;
    const fx=g.x+g.w/2+Math.cos(g.facing)*28,fy=g.y+g.h/2+Math.sin(g.facing)*28;
    glow(fx,fy,98,g.state==='chase'?'rgba(255,50,50,0.09)':'rgba(180,200,255,0.065)');
  }
  guardGlow(DAD);guardGlow(MOM);
  if(!phone.col)glow(phone.x+6,phone.y+7,36,'rgba(60,140,255,0.085)');
  if(redKey.exists&&!redKey.col)glow(redKey.x+7,redKey.y+5,28,'rgba(231,76,60,0.18)');
  if(tablet.exists&&!tablet.col)glow(tablet.x+9,tablet.y+7,40,'rgba(255,107,157,0.12)');
  if(keyItem.exists&&!keyItem.col)glow(keyItem.x+7,keyItem.y+5,42,'rgba(253,203,80,0.18)');
  if(guestDoor&&guestDoor.locked)glow(guestDoor.x+5,guestDoor.y+20,30,'rgba(220,60,30,0.07)');
  if(snack.exists&&!snack.col)glow(snack.x+7,snack.y+6,24,'rgba(0,184,148,0.08)');
  ctx.drawImage(lc,0,0);
}

// ‚îÄ‚îÄ DOG AI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateDog(){
  const spd=dog.spd*settings.guardSpd;
  if(dog.state==='patrol'){
    const pt=dog.pts[dog.cp];
    const dx=pt.x-dog.x,dy=pt.y-dog.y,d=Math.sqrt(dx*dx+dy*dy);
    if(d>2){
      dog.x+=dx/d*spd;dog.y+=dy/d*spd;
      dog.facing=Math.atan2(dy,dx);
    }
    dog.wt++;
    if(dog.wt>55){dog.cp=(dog.cp+1)%dog.pts.length;dog.wt=0;}
    dog.wtt++;if(dog.wtt>8){dog.wf=(dog.wf+1)%4;dog.wtt=0;}
    dog.sc++;
    // Spot player if outdoor and not hidden
    if(outdoor&&!P.hidden){
      const ddist=dst(dog.x+dog.w/2,dog.y+dog.h/2,P.x+P.w/2,P.y+P.h/2);
      if(ddist<130){dog.state='chase';toast('üêï The dog spotted you!','#e74c3c',200);}
    }
    // Bark investigate if player runs nearby
    if(outdoor&&P.vx!==0&&P.vy!==0){
      const ddist=dst(dog.x+dog.w/2,dog.y+dog.h/2,P.x+P.w/2,P.y+P.h/2);
      if(ddist<200&&Math.random()<0.005){
        dog.state='sniff';dog.ix=P.x;dog.iy=P.y;dog.sc=0;
        toast('üêï Dog is sniffing around...','#fdcb6e',160);
      }
    }
  } else if(dog.state==='sniff'){
    const dx=dog.ix-dog.x,dy=dog.iy-dog.y,d=Math.sqrt(dx*dx+dy*dy);
    if(d>4){dog.x+=dx/d*spd*0.7;dog.y+=dy/d*spd*0.7;dog.facing=Math.atan2(dy,dx);}
    dog.sc++;
    // Spot player while sniffing
    if(outdoor&&!P.hidden&&dst(dog.x,dog.y,P.x,P.y)<100){dog.state='chase';}
    if(dog.sc>120){dog.state='patrol';dog.sc=0;}
  } else if(dog.state==='chase'){
    const tx=P.x+P.w/2-dog.w/2,ty=P.y+P.h/2-dog.h/2;
    const dx=tx-dog.x,dy=ty-dog.y,d=Math.sqrt(dx*dx+dy*dy);
    if(d>2){dog.x+=dx/d*dog.rspd*settings.guardSpd;dog.y+=dy/d*dog.rspd*settings.guardSpd;dog.facing=Math.atan2(dy,dx);}
    dog.wtt++;if(dog.wtt>5){dog.wf=(dog.wf+1)%4;dog.wtt=0;}
    // Give up if player hides or re-enters house
    if(P.hidden||!outdoor){dog.state='patrol';dog.sc=0;}
    // Bark at parents window to alert guards
    dog.sc++;
    if(dog.sc===60){
      // Dog barking wakes DAD if he was sleeping or alerts him
      if(DAD.sleeping){DAD.sleeping=false;DAD.st=0;DAD.state='patrol';toast('üêï BARK! Dad woke up!','#e74c3c',220);}
      else if(DAD.state==='patrol'){DAD.state='investigate';DAD.ix=frontDoor.x;DAD.iy=frontDoor.y;}
    }
  }
}

// ‚îÄ‚îÄ OUTDOOR DRAWING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function drawOutdoor(){
  if(!LEVELS[curLvl].outdoor)return;

  // Yard background ‚Äî dark grass
  ctx.fillStyle='#0a1a08';ctx.fillRect(30,622,420,248);

  // Grass texture ‚Äî horizontal strips
  for(let y=630;y<870;y+=8){
    const shade=y%16===0?'rgba(20,60,15,0.4)':'rgba(10,40,8,0.2)';
    ctx.fillStyle=shade;ctx.fillRect(30,y,420,8);
  }

  // Grass blades (decorative dots/lines)
  ctx.fillStyle='#1a3a10';
  for(let gx=40;gx<450;gx+=14){
    for(let gy=630;gy<870;gy+=14){
      if((gx+gy)%28===0){
        ctx.fillRect(gx,gy,2,5);
        ctx.fillRect(gx+4,gy+2,1,4);
      }
    }
  }

  // Path from front door to yard
  ctx.fillStyle='#1e1a10';
  ctx.fillRect(180,615,80,60);
  ctx.fillStyle='#241e12';
  for(let py=620;py<672;py+=12)ctx.fillRect(182,py,76,6);

  // Garden table (where phone is)
  if(!phone.col){
    ctx.fillStyle='rgba(0,0,0,0.3)';ctx.fillRect(314,754,52,14);
    ctx.fillStyle='#3a2810';ctx.fillRect(310,750,50,12);
    ctx.fillStyle='rgba(255,255,255,0.06)';ctx.fillRect(310,750,50,3);
    ctx.fillStyle='#2a1e08';ctx.fillRect(325,762,6,14);ctx.fillRect(339,762,6,14);
  }

  // Bushes (hideable) ‚Äî dark green clusters
  const bushes=[
    {x:40,y:640,w:55,h:40},{x:40,y:780,w:55,h:50},
    {x:380,y:650,w:55,h:40},{x:375,y:790,w:60,h:50},
    {x:170,y:820,w:50,h:40},{x:260,y:830,w:45,h:35},
  ];
  bushes.forEach(b=>{
    ctx.fillStyle='rgba(0,0,0,0.3)';ctx.fillRect(b.x+3,b.y+4,b.w,b.h);
    ctx.fillStyle='#0d2a08';ctx.fillRect(b.x,b.y,b.w,b.h);
    // Leaf texture
    ctx.fillStyle='#142e10';
    for(let lx=b.x+4;lx<b.x+b.w-4;lx+=10)
      for(let ly=b.y+4;ly<b.y+b.h-4;ly+=10)
        ctx.fillRect(lx,ly,6,6);
    ctx.fillStyle='#1a401a';
    for(let lx=b.x+6;lx<b.x+b.w-6;lx+=10)
      for(let ly=b.y+6;ly<b.y+b.h-6;ly+=10)
        ctx.fillRect(lx,ly,3,3);
    // Hide-in-bush glow
    ctx.strokeStyle='rgba(0,184,148,0.15)';ctx.lineWidth=1.5;
    ctx.strokeRect(b.x+1,b.y+1,b.w-2,b.h-2);
  });

  // Fence at bottom
  ctx.fillStyle='#2a1e0c';
  for(let fx=35;fx<445;fx+=18){
    ctx.fillRect(fx,855,12,20);
    ctx.fillRect(fx-1,853,14,6);
  }
  ctx.fillStyle='#1e1408';ctx.fillRect(30,864,420,6);

  // Stars in the outdoor area
  const starSeed=[2,7,13,19,23,31,37,43,47,53];
  ctx.fillStyle='rgba(255,255,255,0.5)';
  starSeed.forEach((s,i)=>{
    const sx=40+(s*47)%390,sy=625+(s*31)%80;
    const twinkle=Math.abs(Math.sin(gt*0.03+i))*0.6+0.1;
    ctx.globalAlpha=twinkle;
    ctx.fillRect(sx,sy,1,1);
  });
  ctx.globalAlpha=1;

  // "OUTSIDE" zone label
  ctx.font='6px monospace';ctx.fillStyle='rgba(80,180,80,0.25)';ctx.textAlign='center';
  ctx.fillText('‚Äî YARD ‚Äî',240,640);ctx.textAlign='left';
}

function drawFrontDoor(){
  if(!LEVELS[curLvl].outdoor)return;
  const fd=frontDoor;
  // Door frame
  ctx.fillStyle='#0c0c08';ctx.fillRect(fd.x-3,fd.y-2,fd.w+6,fd.h+6);
  if(fd.locked){
    ctx.fillStyle='#1a0808';ctx.fillRect(fd.x,fd.y,fd.w,fd.h);
    const lp=Math.abs(Math.sin(gt*0.06))*0.4+0.2;
    ctx.fillStyle=`rgba(220,40,20,${lp})`;ctx.fillRect(fd.x,fd.y,fd.w,fd.h);
    // Keyhole
    ctx.fillStyle='#cc3010';
    ctx.beginPath();ctx.arc(fd.x+fd.w/2,fd.y+fd.h/2-2,3,0,Math.PI*2);ctx.fill();
    ctx.fillRect(fd.x+fd.w/2-2,fd.y+fd.h/2+1,4,5);
    // "LOCKED" label
    ctx.font='5px monospace';ctx.fillStyle='rgba(220,80,60,0.8)';ctx.textAlign='center';
    ctx.fillText('LOCKED',fd.x+fd.w/2,fd.y-3);ctx.textAlign='left';
  } else {
    // Open/swinging door
    const ang=fd.ang*Math.PI/180;
    ctx.save();ctx.translate(fd.x+fd.w/2,fd.y+fd.h/2);ctx.scale(1,Math.cos(ang));
    ctx.fillStyle='#3a2810';ctx.fillRect(-fd.w/2,-fd.h/2,fd.w,fd.h);
    ctx.fillStyle='rgba(255,255,255,0.06)';ctx.fillRect(-fd.w/2,-fd.h/2,fd.w,fd.h/3);
    ctx.fillStyle='#c8a040';ctx.fillRect(fd.w/2-5,-2,4,5);
    ctx.restore();
  }
  // "FRONT DOOR" hint when player has red key and near
  if(P.hasRedKey&&fd.locked){
    const px=P.x+P.w/2,py=P.y+P.h/2;
    if(Math.abs(px-(fd.x+fd.w/2))<50&&Math.abs(py-(fd.y+fd.h/2))<50){
      ctx.font='6px monospace';ctx.fillStyle='rgba(0,184,148,0.9)';ctx.textAlign='center';
      ctx.fillText('[ E ] UNLOCK',fd.x+fd.w/2,fd.y-10);ctx.textAlign='left';
    }
  }
}

function drawDog(){
  if(!dog.active)return;
  const x=Math.round(dog.x),y=Math.round(dog.y);
  const alert=dog.state==='chase';
  // Shadow
  ctx.fillStyle='rgba(0,0,0,0.25)';ctx.fillRect(x+2,y+dog.h,dog.w,4);
  // Body
  ctx.fillStyle=alert?'#5a1a00':'#7a4a1a';ctx.fillRect(x,y+4,dog.w,dog.h-4);
  // Head
  ctx.fillStyle=alert?'#7a2a00':'#9a5a20';ctx.fillRect(x+dog.w-8,y,10,10);
  // Ears
  ctx.fillStyle=alert?'#6a1800':'#6a3a10';
  ctx.fillRect(x+dog.w-6,y-3,4,5);ctx.fillRect(x+dog.w+1,y-3,4,5);
  // Tail wag
  const tailWag=Math.sin(gt*0.15)*3;
  ctx.fillStyle='#7a4a1a';ctx.fillRect(x-4,y+4+tailWag,5,4);
  // Legs (walk animation)
  const lf=dog.wf;
  ctx.fillStyle='#5a3010';
  ctx.fillRect(x+4+(lf%2?2:0),y+dog.h,3,5);
  ctx.fillRect(x+10+(lf%2?0:2),y+dog.h,3,5);
  ctx.fillRect(x+dog.w-8+(lf%2?2:0),y+dog.h,3,5);
  ctx.fillRect(x+dog.w-4+(lf%2?0:2),y+dog.h,3,5);
  // Eyes
  ctx.fillStyle=alert?'#ff2000':'#1a1a10';
  const ex=x+dog.w+(Math.cos(dog.facing)>0?2:-4);
  ctx.fillRect(ex,y+2,3,3);
  // Alert exclamation
  if(alert){
    ctx.fillStyle='#ff2020';ctx.font='bold 10px monospace';ctx.textAlign='center';
    ctx.fillText('!',x+dog.w/2,y-5);ctx.textAlign='left';
  }
  // Dog label
  ctx.font='5px monospace';ctx.fillStyle='rgba(255,180,100,0.5)';ctx.textAlign='center';
  ctx.fillText('DOG',x+dog.w/2,y-10);ctx.textAlign='left';
}

function drawRedKey(){
  if(!redKey.exists||redKey.col)return;
  const kx=redKey.x,ky=redKey.y;
  const g2=Math.sin(gt*0.09)*0.15+0.25;
  const gr2=ctx.createRadialGradient(kx+7,ky+5,0,kx+7,ky+5,22);
  gr2.addColorStop(0,`rgba(231,76,60,${g2+0.15})`);gr2.addColorStop(1,'transparent');
  ctx.fillStyle=gr2;ctx.fillRect(kx-15,ky-15,44,44);
  ctx.strokeStyle='#cc2010';ctx.lineWidth=2;
  ctx.beginPath();ctx.arc(kx+4,ky+5,4,0,Math.PI*2);ctx.stroke();
  ctx.fillStyle='#e03020';ctx.fillRect(kx+6,ky+4,8,2);
  ctx.fillRect(kx+9,ky+6,2,2);ctx.fillRect(kx+12,ky+6,2,2);
  // "RED KEY" label
  ctx.font='5px monospace';ctx.fillStyle='rgba(231,76,60,0.7)';ctx.textAlign='center';
  ctx.fillText('RED KEY',kx+7,ky-4);ctx.textAlign='left';
}

// Outdoor hide-in-bush check
function bushHideSpot(px,py){
  const bushes=[
    {x:40,y:640,w:55,h:40},{x:40,y:780,w:55,h:50},
    {x:380,y:650,w:55,h:40},{x:375,y:790,w:60,h:50},
    {x:170,y:820,w:50,h:40},{x:260,y:830,w:45,h:35},
  ];
  for(const b of bushes){
    if(px>b.x+8&&px<b.x+b.w-8&&py>b.y+8&&py<b.y+b.h-8)return b;
  }
  return null;
}

function draw(){
  ctx.save();ctx.translate(shake.x,shake.y);
  ctx.fillStyle='#04040d';ctx.fillRect(-12,-12,GW+24,GH+24);
  drawOutdoor();
  drawRooms();
  FURN.forEach(f=>{if(LEVELS[curLvl].outdoor&&f.y>=620)return;drawFurn(f);});
  drawCreaks();drawKeys();drawRedKey();drawSnack();drawPhone();drawTablet();
  drawFrontDoor();drawDog();
  drawVision(DAD);drawVision(MOM);
  drawPlayer();
  drawGuard(DAD,false);drawGuard(MOM,true);
  drawWalls();doors.forEach(drawDoor);drawGuestDoor();
  drawLighting();
  // Particles
  parts.forEach(p=>{ctx.globalAlpha=p.life/55;ctx.fillStyle=p.col;ctx.fillRect(p.x-p.sz/2,p.y-p.sz/2,p.sz,p.sz);});
  ctx.globalAlpha=1;
  // Vignette
  const v=ctx.createRadialGradient(GW/2,GH/2,GH*0.25,GW/2,GH/2,GH*0.78);
  v.addColorStop(0,'transparent');v.addColorStop(1,'rgba(0,0,6,0.55)');
  ctx.fillStyle=v;ctx.fillRect(0,0,GW,GH);
  // Chase red pulse
  if(DAD.state==='chase'||MOM.state==='chase'){
    ctx.fillStyle=`rgba(200,0,0,${Math.abs(Math.sin(gt*0.08))*0.06})`;ctx.fillRect(0,0,GW,GH);
  }
  // Lights out overlay
  if(LEVELS[curLvl].lights&&!lightOn){
    ctx.fillStyle='rgba(0,0,8,0.6)';ctx.fillRect(0,0,GW,GH);
    // Small lamp glow around player
    const lamp=ctx.createRadialGradient(P.x+P.w/2,P.y+P.h/2,0,P.x+P.w/2,P.y+P.h/2,70);
    lamp.addColorStop(0,'rgba(0,0,8,0)');lamp.addColorStop(1,'rgba(0,0,8,0.55)');
    ctx.fillStyle=lamp;ctx.fillRect(P.x-80,P.y-80,P.w+160,P.h+160);
  }
  // Sleep pulse
  if(DAD.sleeping){const p2=Math.abs(Math.sin(gt*0.06))*0.04+0.015;ctx.fillStyle=`rgba(162,155,254,${p2})`;ctx.fillRect(0,0,GW,GH);}
  // Float texts
  floats.forEach(f=>{ctx.globalAlpha=f.life/f.ml;ctx.fillStyle=f.c;ctx.font='bold 11px monospace';ctx.textAlign='center';ctx.fillText(f.t,f.x,f.y);});
  ctx.globalAlpha=1;ctx.textAlign='left';
  // Version watermark
  ctx.save();
  ctx.font='5px monospace';
  ctx.fillStyle='rgba(162,155,254,0.25)';
  ctx.textAlign='right';
  ctx.fillText(GAME_VERSION,GW-8,GH-8);
  ctx.textAlign='left';
  ctx.restore();
}

function loop(){if(!gr||paused)return;update();draw();if(controlScheme==='pc')updatePCKeyVisuals();requestAnimationFrame(loop);}

// Auto-detect controls: touchscreen = mobile, mouse-only = PC
(function(){
  const isTouch='ontouchstart' in window||navigator.maxTouchPoints>0;
  if(!isTouch)setControls('pc');
  else setControls('mobile');
})();

draw();
</script>
</body>
</html>
