<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PAST MY BEDTIME ‚Äî HORROR EDITION</title>
<link href="https://fonts.googleapis.com/css2?family=Creepster&family=Special+Elite&family=VT323&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{background:#000;overflow:hidden;font-family:'Special Elite',cursive;cursor:none;}
#c{display:block;width:100vw;height:100vh;}

/* Custom cursor */
#cursor{position:fixed;width:20px;height:20px;pointer-events:none;z-index:9999;transform:translate(-50%,-50%);}
#cursor::before,#cursor::after{content:'';position:absolute;background:#ff0000;opacity:0.8;}
#cursor::before{width:2px;height:20px;left:9px;top:0;}
#cursor::after{width:20px;height:2px;top:9px;left:0;}

/* HUD */
#hud{position:fixed;inset:0;pointer-events:none;z-index:100;}

/* Crosshair */
#xhair{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:24px;height:24px;}
#xhair::before,#xhair::after{content:'';position:absolute;background:rgba(255,60,0,0.7);}
#xhair::before{width:1px;height:24px;left:11.5px;}
#xhair::after{width:24px;height:1px;top:11.5px;}

/* Vignette overlay */
#vignette{position:fixed;inset:0;background:radial-gradient(ellipse at center,transparent 40%,rgba(0,0,0,0.85) 100%);pointer-events:none;z-index:50;}

/* Blood splatter on caught */
#bloodOverlay{position:fixed;inset:0;background:radial-gradient(ellipse at center,rgba(180,0,0,0.6) 0%,transparent 70%);pointer-events:none;z-index:60;opacity:0;transition:opacity 0.1s;}

/* Flicker overlay */
#flicker{position:fixed;inset:0;pointer-events:none;z-index:55;opacity:0;background:#0a0005;}

/* Stats top-left */
#stats{position:fixed;top:16px;left:16px;display:flex;flex-direction:column;gap:6px;}
.stat-pill{background:rgba(0,0,0,0.75);border:1px solid rgba(180,0,0,0.4);padding:5px 10px;font-family:'VT323',monospace;font-size:18px;letter-spacing:0.1em;color:#cc3333;}
.stat-label{color:#660000;font-size:13px;margin-right:4px;}

/* Sanity bar */
#sanityWrap{position:fixed;bottom:28px;left:50%;transform:translateX(-50%);display:flex;flex-direction:column;align-items:center;gap:4px;}
#sanityLabel{font-family:'VT323',monospace;font-size:15px;color:#660000;letter-spacing:0.15em;}
#sanityBar{width:220px;height:8px;background:rgba(0,0,0,0.8);border:1px solid #330000;}
#sanityFill{height:100%;width:100%;background:linear-gradient(90deg,#ff0000,#ff6600);transition:width 0.2s;}

/* Objective */
#obj{position:fixed;top:16px;right:16px;max-width:200px;text-align:right;}
#objTitle{font-family:'VT323',monospace;font-size:16px;color:#660000;letter-spacing:0.1em;margin-bottom:4px;}
.obj-item{font-family:'VT323',monospace;font-size:18px;color:#993333;line-height:1.4;}
.obj-item.done{color:#336633;text-decoration:line-through;opacity:0.6;}

/* Noise indicator */
#noiseEl{position:fixed;bottom:60px;left:50%;transform:translateX(-50%);font-family:'Creepster',cursive;font-size:22px;color:#ff0000;letter-spacing:0.2em;opacity:0;transition:opacity 0.1s;text-shadow:0 0 20px #ff0000;}

/* Toast */
#toastBox{position:fixed;bottom:100px;left:50%;transform:translateX(-50%);display:flex;flex-direction:column;align-items:center;gap:6px;z-index:200;}
.toast-msg{font-family:'VT323',monospace;font-size:22px;padding:5px 16px;background:rgba(0,0,0,0.85);border:1px solid #660000;color:#cc4444;letter-spacing:0.08em;animation:toastAnim 2.5s ease-out forwards;}
@keyframes toastAnim{0%{opacity:0;transform:translateY(10px);}15%{opacity:1;transform:translateY(0);}80%{opacity:1;}100%{opacity:0;transform:translateY(-15px);}}

/* Footstep echo visual */
#footEcho{position:fixed;bottom:40px;right:20px;font-family:'VT323',monospace;font-size:14px;color:rgba(150,0,0,0.6);letter-spacing:0.1em;}

/* ‚îÄ‚îÄ SCREENS ‚îÄ‚îÄ */
.screen{position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:500;background:#000;}

/* Title screen */
#titleScreen{background:radial-gradient(ellipse at 50% 40%,#0d0004 0%,#000 100%);}
.title-flicker{animation:titleFlicker 4s ease-in-out infinite;}
@keyframes titleFlicker{0%,100%{opacity:1;}48%{opacity:1;}50%{opacity:0.4;}52%{opacity:1;}92%{opacity:1;}93%{opacity:0.7;}94%{opacity:1;}96%{opacity:0.5;}97%{opacity:1;}}
.title-main{font-family:'Creepster',cursive;font-size:clamp(36px,8vw,80px);color:#cc0000;text-shadow:0 0 40px #ff000066,0 0 80px #cc000033,4px 4px 0 #440000;letter-spacing:0.05em;text-align:center;}
.title-sub{font-family:'Special Elite',cursive;font-size:clamp(12px,2.5vw,18px);color:#661111;letter-spacing:0.3em;margin-top:6px;text-align:center;}
.title-horror{font-family:'VT323',monospace;font-size:clamp(10px,2vw,16px);color:#440000;letter-spacing:0.5em;margin-top:4px;text-align:center;}
.title-desc{font-family:'Special Elite',cursive;font-size:clamp(10px,1.8vw,13px);color:#552222;line-height:2;margin:22px 0;text-align:center;max-width:380px;}
.title-desc em{color:#993333;font-style:normal;}

/* Ambient drips */
.drip{position:absolute;width:2px;background:linear-gradient(180deg,#cc0000,#440000);animation:drip var(--d,3s) ease-in infinite var(--dl,0s);}
@keyframes drip{0%{height:0;top:0;opacity:1;}80%{opacity:1;}100%{height:var(--h,80px);top:var(--t,100px);opacity:0;}}

/* Buttons */
.btn{background:transparent;border:1px solid #550000;color:#993333;padding:10px 28px;font-family:'Special Elite',cursive;font-size:clamp(11px,2vw,14px);cursor:pointer;letter-spacing:0.15em;transition:all 0.2s;margin:4px;position:relative;overflow:hidden;}
.btn::before{content:'';position:absolute;inset:0;background:#cc0000;transform:scaleX(0);transform-origin:left;transition:transform 0.2s;z-index:-1;}
.btn:hover{color:#fff;border-color:#cc0000;box-shadow:0 0 20px rgba(200,0,0,0.4);}
.btn:hover::before{transform:scaleX(1);}
.btn:active{transform:scale(0.97);}

/* Game over */
#gameOverScreen{background:rgba(0,0,0,0.96);}
.go-icon{font-size:60px;animation:pulse 1s ease-in-out infinite;}
@keyframes pulse{0%,100%{transform:scale(1);}50%{transform:scale(1.1);}}
.go-title{font-family:'Creepster',cursive;font-size:clamp(32px,7vw,64px);color:#cc0000;text-shadow:0 0 30px #ff0000;margin:10px 0;}
.go-sub{font-family:'Special Elite',cursive;font-size:clamp(11px,2vw,14px);color:#662222;margin-bottom:20px;text-align:center;}

/* Win screen */
#winScreen{background:rgba(0,0,0,0.96);}
.win-title{font-family:'Creepster',cursive;font-size:clamp(28px,6vw,56px);color:#006600;text-shadow:0 0 30px #00aa00;margin:10px 0;}

/* Pause */
#pauseScreen{background:rgba(0,0,0,0.92);backdrop-filter:blur(4px);}
.pause-title{font-family:'Creepster',cursive;font-size:clamp(24px,5vw,48px);color:#993300;margin-bottom:20px;}

/* Level intro */
#levelCard{background:rgba(0,0,0,0.97);}
.lc-num{font-family:'VT323',monospace;font-size:clamp(14px,2.5vw,18px);color:#440000;letter-spacing:0.3em;margin-bottom:6px;}
.lc-title{font-family:'Creepster',cursive;font-size:clamp(22px,5vw,44px);color:#cc0000;text-shadow:0 0 20px #ff000055;margin-bottom:8px;}
.lc-desc{font-family:'Special Elite',cursive;font-size:clamp(10px,1.8vw,13px);color:#664444;line-height:2;margin-bottom:14px;text-align:center;max-width:360px;}
.lc-tip{font-family:'VT323',monospace;font-size:clamp(14px,2.2vw,17px);color:#553333;margin-bottom:14px;letter-spacing:0.08em;}
.lc-objs{display:flex;flex-direction:column;gap:4px;margin-bottom:16px;align-items:center;}
.lc-obj{font-family:'VT323',monospace;font-size:clamp(15px,2.5vw,19px);color:#882222;letter-spacing:0.05em;}

/* Diff select */
#diffScreen{background:radial-gradient(ellipse at 50% 30%,#0d0004 0%,#000 100%);}
.diff-card{border:1px solid #330000;padding:14px 20px;margin:5px;cursor:pointer;max-width:300px;width:100%;transition:all 0.2s;background:rgba(0,0,0,0.6);}
.diff-card:hover{border-color:#cc0000;background:rgba(80,0,0,0.2);}
.diff-name{font-family:'Creepster',cursive;font-size:clamp(16px,3vw,22px);margin-bottom:4px;}
.diff-desc{font-family:'Special Elite',cursive;font-size:clamp(9px,1.6vw,11px);color:#553333;line-height:1.8;}

/* Minimap */
#minimap{position:fixed;bottom:16px;right:16px;width:110px;height:110px;background:rgba(0,0,0,0.8);border:1px solid rgba(180,0,0,0.35);overflow:hidden;}
#minimapCanvas{display:block;width:110px;height:110px;image-rendering:pixelated;}

/* Audio prompt */
#audioPrompt{position:fixed;bottom:16px;left:50%;transform:translateX(-50%);font-family:'VT323',monospace;font-size:14px;color:#440000;letter-spacing:0.15em;animation:blink 1.2s step-end infinite;}
@keyframes blink{0%,100%{opacity:1;}50%{opacity:0;}}

/* Controls hint */
#ctrlHint{position:fixed;bottom:16px;left:16px;font-family:'VT323',monospace;font-size:13px;color:#330000;line-height:1.8;letter-spacing:0.05em;}

.hidden{display:none!important;}
</style>
</head>
<body>
<canvas id="c"></canvas>
<div id="cursor"></div>

<!-- HUD -->
<div id="hud" class="hidden">
  <div id="xhair"></div>
  <div id="stats">
    <div class="stat-pill"><span class="stat-label">LVL</span><span id="lvlStat">1</span></div>
    <div class="stat-pill"><span class="stat-label">STREAK</span><span id="streakStat">0</span></div>
  </div>
  <div id="obj">
    <div id="objTitle">‚ñ∏ OBJECTIVES</div>
    <div id="objList"></div>
  </div>
  <div id="sanityWrap">
    <div id="sanityLabel">SANITY</div>
    <div id="sanityBar"><div id="sanityFill"></div></div>
  </div>
  <div id="noiseEl">‚ö† MAKING NOISE ‚ö†</div>
  <div id="footEcho"></div>
  <div id="toastBox"></div>
  <div id="audioPrompt">[ CLICK TO ENABLE AUDIO ]</div>
  <div id="ctrlHint">WASD/ARROWS ¬∑ SHIFT=RUN ¬∑ SPACE=HIDE ¬∑ E=USE/INTERACT</div>
</div>
<div id="vignette"></div>
<div id="bloodOverlay"></div>
<div id="flicker"></div>
<div id="minimap" class="hidden"><canvas id="minimapCanvas" width="110" height="110"></canvas></div>

<!-- TITLE -->
<div id="titleScreen" class="screen">
  <!-- Blood drips (injected by JS) -->
  <div class="title-flicker">
    <div class="title-main">PAST MY BEDTIME</div>
    <div class="title-sub">H O R R O R  E D I T I O N</div>
    <div class="title-horror">‚ñ∏ YOU SHOULD NOT BE UP ‚óÇ</div>
  </div>
  <div class="title-desc">
    Something is wrong in the house tonight.<br>
    <em>Dad isn't just looking for you.</em><br>
    He's hunting you.
  </div>
  <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:center;">
    <button class="btn" onclick="showDiff()">‚ñ∂ BEGIN THE NIGHTMARE</button>
    <button class="btn" onclick="showCredits()" style="font-size:11px;">üìã HOW TO PLAY</button>
  </div>
  <div style="margin-top:18px;font-family:'VT323',monospace;font-size:13px;color:#330000;letter-spacing:0.2em;">WASD ¬∑ MOUSE LOOK ¬∑ SHIFT=RUN ¬∑ SPACE=HIDE ¬∑ E=USE</div>
</div>

<!-- DIFF SELECT -->
<div id="diffScreen" class="screen hidden">
  <div style="font-family:'Creepster',cursive;font-size:clamp(20px,4vw,36px);color:#880000;margin-bottom:16px;letter-spacing:0.05em;">CHOOSE YOUR FATE</div>
  <div class="diff-card" onclick="pickDiff('easy')">
    <div class="diff-name" style="color:#228822;">üü¢ RESTLESS</div>
    <div class="diff-desc">Dad moves slowly and doesn't hear well.<br>Good for first-timers with a faint heart.</div>
  </div>
  <div class="diff-card" onclick="pickDiff('medium')">
    <div class="diff-name" style="color:#aa6622;">üü† NIGHTMARE</div>
    <div class="diff-desc">Standard dread. The classic experience.<br>You will be afraid.</div>
  </div>
  <div class="diff-card" onclick="pickDiff('hard')">
    <div class="diff-name" style="color:#cc1111;">üî¥ PURE TERROR</div>
    <div class="diff-desc">Dad is relentless. He never sleeps. No mercy.<br>For the truly damned.</div>
  </div>
  <button class="btn" onclick="backToTitle()" style="margin-top:12px;">‚Üê BACK</button>
</div>

<!-- LEVEL CARD -->
<div id="levelCard" class="screen hidden">
  <div class="lc-num" id="lcNum">‚Äî NIGHT ONE ‚Äî</div>
  <div class="lc-title" id="lcTitle">THE AWAKENING</div>
  <div class="lc-desc" id="lcDesc"></div>
  <div class="lc-tip" id="lcTip"></div>
  <div class="lc-objs" id="lcObjs"></div>
  <button class="btn" onclick="startLevel()">‚ñ∂ ENTER THE DARKNESS</button>
</div>

<!-- PAUSE -->
<div id="pauseScreen" class="screen hidden">
  <div class="pause-title">‚Äî PAUSED ‚Äî</div>
  <div style="display:flex;flex-direction:column;gap:8px;align-items:center;">
    <button class="btn" onclick="resumeGame()">‚ñ∂ CONTINUE</button>
    <button class="btn" onclick="quitToTitle()">‚úï ABANDON</button>
  </div>
  <div style="margin-top:16px;font-family:'VT323',monospace;font-size:13px;color:#440000;line-height:2;text-align:center;letter-spacing:0.08em;">
    WASD ¬∑ MOUSE LOOK<br>SHIFT = RUN (noisy!)<br>SPACE = HIDE in furniture<br>E = USE / INTERACT<br>ESC = PAUSE
  </div>
</div>

<!-- GAME OVER -->
<div id="gameOverScreen" class="screen hidden">
  <div class="go-icon">üò±</div>
  <div class="go-title">CAUGHT.</div>
  <div class="go-sub" id="goReason">Dad found you.</div>
  <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:center;">
    <button class="btn" onclick="retryLevel()">‚Ü∫ TRY AGAIN</button>
    <button class="btn" onclick="quitToTitle()">‚úï GIVE UP</button>
  </div>
</div>

<!-- WIN -->
<div id="winScreen" class="screen hidden">
  <div style="font-size:50px;">üåô</div>
  <div class="win-title" id="winTitle">YOU SURVIVED.</div>
  <div class="go-sub" id="winSub"></div>
  <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:center;">
    <button class="btn" id="nextBtn" onclick="nextLevel()">‚ñ∂ NEXT NIGHT</button>
    <button class="btn" onclick="quitToTitle()">‚Üê TITLE</button>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
/* ============================================================
   PAST MY BEDTIME ‚Äî FULL WORKING HORROR BUILD
   Complete + Fixed Version
============================================================ */

const canvas = document.getElementById("c");

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ THREE SETUP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
const renderer = new THREE.WebGLRenderer({canvas, antialias:true});
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.shadowMap.enabled = true;
renderer.setPixelRatio(Math.min(window.devicePixelRatio,1.5));

const scene = new THREE.Scene();
scene.fog = new THREE.FogExp2(0x000000,0.12);

const camera = new THREE.PerspectiveCamera(
  75,
  window.innerWidth/window.innerHeight,
  0.1,
  40
);

camera.position.set(0,0.9,0);

window.addEventListener("resize",()=>{
  renderer.setSize(window.innerWidth, window.innerHeight);
  camera.aspect = window.innerWidth/window.innerHeight;
  camera.updateProjectionMatrix();
});

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */

let gameRunning=false;
let paused=false;
let difficulty="medium";
let curLvl=0;
let sanity=0;
let streak=0;

const DIFF_MULT = {easy:0.7, medium:1, hard:1.4};

const player={
  x:-5,
  z:-4,
  velX:0,
  velZ:0,
  hidden:false,
  hasPhone:false,
  hasKey:false
};

let guardDad=null;
let guardMom=null;
let guestDoorLocked=true;
let phoneMesh=null;
let keyMesh=null;
let bedMesh=null;

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ MATERIALS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */

const MAT={
  wall:new THREE.MeshLambertMaterial({color:0x1a1010}),
  floor:new THREE.MeshLambertMaterial({color:0x120c08}),
  door:new THREE.MeshLambertMaterial({color:0x1a0000}),
  phone:new THREE.MeshLambertMaterial({color:0x0044ff,emissive:0x0066ff}),
  key:new THREE.MeshLambertMaterial({color:0xffaa00,emissive:0xffaa00}),
  guard:new THREE.MeshLambertMaterial({color:0x1c1c1c}),
  bed:new THREE.MeshLambertMaterial({color:0x1a1030})
};

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */

function box(w,h,d,mat,x,y,z){
  const m=new THREE.Mesh(new THREE.BoxGeometry(w,h,d),mat);
  m.position.set(x,y,z);
  m.castShadow=true;
  m.receiveShadow=true;
  scene.add(m);
  return m;
}

function clearScene(){
  while(scene.children.length>0){
    scene.remove(scene.children[0]);
  }
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ BUILD MAP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */

function buildMap(){

  clearScene();

  scene.add(new THREE.AmbientLight(0x050203,0.9));

  const light=new THREE.PointLight(0xff3300,0.6,10);
  light.position.set(0,2,0);
  scene.add(light);

  // Floors
  box(4,0.1,4,MAT.floor,-5,0,-4);
  box(4,0.1,4,MAT.floor,-5,0,0);
  box(4,0.1,4,MAT.floor,-5,0,4);
  box(1.5,0.1,12,MAT.floor,0,0,0);
  box(4,0.1,4,MAT.floor,5,0,-4);
  box(4,0.1,4,MAT.floor,5,0,0);
  box(4,0.1,4,MAT.floor,5,0,4);

  // Walls outer
  box(0.2,2.8,12,MAT.wall,-7,1.4,0);
  box(0.2,2.8,12,MAT.wall,7,1.4,0);
  box(14,2.8,0.2,MAT.wall,0,1.4,-6);
  box(14,2.8,0.2,MAT.wall,0,1.4,6);

  // Guest Door
  const door=box(0.2,2.3,1,MAT.door,2.25,1.1,4);
  door.userData.isDoor=true;

  // Bed
  bedMesh=box(1.5,0.5,0.8,MAT.bed,-5,0.25,-5.2);
  bedMesh.userData.isBed=true;

  // Phone
  phoneMesh=box(0.15,0.03,0.25,MAT.phone,5.2,0.7,4.8);
  phoneMesh.userData.isPhone=true;

  // Key
  keyMesh=box(0.2,0.05,0.1,MAT.key,-4.8,1.0,-0.8);
  keyMesh.userData.isKey=true;

  buildGuards();
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ GUARDS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */

function makeGuard(x,z,speed){
  const g={
    x,z,
    speed,
    state:"patrol",
    patrolIndex:0,
    patrolPoints:[[0,-4],[0,0],[0,4],[3,4],[3,0],[3,-4]]
  };

  g.mesh=new THREE.Mesh(
    new THREE.BoxGeometry(0.5,1.6,0.5),
    MAT.guard
  );

  g.mesh.position.set(x,0.8,z);
  scene.add(g.mesh);

  return g;
}

function buildGuards(){
  const mult=DIFF_MULT[difficulty];

  guardDad=makeGuard(0,0,1.2*mult);

  if(curLvl>=3){
    guardMom=makeGuard(3,0,1.0*mult);
  }
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ INPUT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */

const keys={};

document.addEventListener("keydown",e=>{
  keys[e.code]=true;
  if(e.code==="Escape" && gameRunning) togglePause();
});

document.addEventListener("keyup",e=>{
  keys[e.code]=false;
});

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ MOVEMENT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */

function updatePlayer(dt){

  const speed=keys["ShiftLeft"]?3:1.8;

  let dx=0,dz=0;

  if(keys["KeyW"]||keys["ArrowUp"]) dz-=1;
  if(keys["KeyS"]||keys["ArrowDown"]) dz+=1;
  if(keys["KeyA"]||keys["ArrowLeft"]) dx-=1;
  if(keys["KeyD"]||keys["ArrowRight"]) dx+=1;

  const len=Math.hypot(dx,dz);
  if(len>0){
    dx/=len;
    dz/=len;
  }

  player.x+=dx*speed*dt;
  player.z+=dz*speed*dt;

  camera.position.set(player.x,0.9,player.z);
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ GUARD AI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */

function updateGuard(g,dt){

  const target=g.patrolPoints[g.patrolIndex];
  const dx=target[0]-g.x;
  const dz=target[1]-g.z;

  const dist=Math.hypot(dx,dz);

  if(dist<0.2){
    g.patrolIndex=(g.patrolIndex+1)%g.patrolPoints.length;
  }else{
    g.x+=dx/dist*g.speed*dt;
    g.z+=dz/dist*g.speed*dt;
  }

  g.mesh.position.set(g.x,0.8,g.z);

  const pd=Math.hypot(player.x-g.x,player.z-g.z);
  if(pd<1.2 && !player.hidden){
    loseGame("Dad caught you.");
  }
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ INTERACTION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */

document.addEventListener("keydown",e=>{
  if(e.code==="KeyE" && gameRunning) tryInteract();
});

function tryInteract(){

  const dPhone=Math.hypot(player.x-5.2,player.z-4.8);
  if(dPhone<1 && phoneMesh){
    player.hasPhone=true;
    scene.remove(phoneMesh);
  }

  const dKey=Math.hypot(player.x+4.8,player.z+0.8);
  if(dKey<1 && keyMesh){
    player.hasKey=true;
    scene.remove(keyMesh);
  }

  const dBed=Math.hypot(player.x+5,player.z+5.2);
  if(dBed<1 && player.hasPhone){
    winGame();
  }
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ GAME FLOW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */

function startGame(){
  document.getElementById("titleScreen").classList.add("hidden");
  document.getElementById("hud").classList.remove("hidden");
  gameRunning=true;
  buildMap();
}

function winGame(){
  gameRunning=false;
  document.getElementById("winScreen").classList.remove("hidden");
}

function loseGame(reason){
  gameRunning=false;
  document.getElementById("goReason").innerText=reason;
  document.getElementById("gameOverScreen").classList.remove("hidden");
}

function togglePause(){
  paused=!paused;
  document.getElementById("pauseScreen").classList.toggle("hidden",!paused);
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ LOOP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */

let last=0;

function loop(t){

  requestAnimationFrame(loop);

  const dt=(t-last)/1000;
  last=t;

  if(gameRunning && !paused){

    updatePlayer(dt);
    updateGuard(guardDad,dt);
    if(guardMom) updateGuard(guardMom,dt);

    sanity+=dt*1.5;
    if(sanity>100) loseGame("You lost your sanity.");
  }

  renderer.render(scene,camera);
}

loop();

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */

function showDiff(){ startGame(); }
function showCredits(){ alert("WASD to move. E to interact."); }
function backToTitle(){ location.reload(); }
function pickDiff(d){ difficulty=d; startGame(); }
function resumeGame(){ togglePause(); }
function quitToTitle(){ location.reload(); }
function retryLevel(){ location.reload(); }
function nextLevel(){ location.reload(); }

</script>
</body>
</html>
